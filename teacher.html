<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher | Lingo-Coins</title>
    <link rel="icon" type="image/webp" href="assets/images/icono-moneda.webp">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        @keyframes badgeUnlock { 0% { transform: scale(0) rotate(-10deg); opacity:0; } 60% { transform: scale(1.2) rotate(5deg); } 100% { transform: scale(1) rotate(0); opacity:1; } }
        @keyframes glowPulse { 0%,100% { box-shadow: 0 0 5px gold; } 50% { box-shadow: 0 0 25px gold, 0 0 5px orange; } }
        @keyframes floatUp { 0% { opacity:1; transform:translateY(0); } 100% { opacity:0; transform:translateY(-60px); } }
        @keyframes shimmer { 0% { background-position: -400px 0; } 100% { background-position: 400px 0; } }
        @keyframes slideIn { from { opacity:0; transform:translateX(-20px); } to { opacity:1; transform:translateX(0); } }
        @keyframes countUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        .streak-fire { animation: pulse 1s infinite; }
        .badge-unlock { animation: badgeUnlock 0.5s ease; }
        .challenge-active-card { animation: glowPulse 2s infinite; }
        .coin-float { animation: floatUp 1s ease forwards; position: absolute; color: gold; font-weight: bold; pointer-events: none; }
        .coming-soon-card { opacity:0.75; border:1px solid gold; background: linear-gradient(90deg, transparent 0%, rgba(255,215,0,0.1) 50%, transparent 100%); background-size: 400px 100%; animation: shimmer 2s infinite; }
        .leaderboard-row { animation: slideIn 0.3s ease forwards; }
        .stat-number { animation: countUp 0.5s ease; }
        .admin-stat-unlock { animation: badgeUnlock 650ms cubic-bezier(.2,.8,.2,1) both; transform-origin: center; }
        .absence-badge { background:#dc3545;color:#fff;border-radius:999px;padding:0.2rem 0.5rem;font-size:0.72rem;font-weight:700;display:inline-block;margin-left:0.5rem; }
        .session-breakdown { border:1px solid rgba(255,255,255,0.12); border-radius:10px; padding:0.75rem; margin-bottom:0.65rem; background:rgba(15,23,42,0.35); }

        @media (prefers-reduced-motion: reduce) {
            .streak-fire,
            .badge-unlock,
            .challenge-active-card,
            .coin-float,
            .coming-soon-card,
            .leaderboard-row,
            .stat-number,
            .admin-stat-unlock { animation: none !important; }
        }
    </style>
</head>
<body class="bg-dashboard">
    <div class="decor-overlay" aria-hidden="true"></div>
    <div class="container-custom page-container" style="max-width: 960px;">
        <div class="card card-premium" style="padding: 0; overflow: hidden;">
            <nav class="admin-nav">
                <span class="greeting">Hello <strong id="adminName"></strong>, welcome back!</span>
                <span class="greeting" id="teacherPocketWrap" style="display:none;">ü™ô Your pocket: <strong id="teacherPocket">0</strong> coins</span>
                <a href="#" id="navDashboard" onclick="return window.showAdminView('dashboard')">Dashboard</a>
                <a href="#" id="navInstitutions" onclick="return window.showAdminView('institutions')">Institutions</a>
                <a href="#" id="navUsers" class="active" onclick="return window.showAdminView('users')">Users</a>
                <a href="#" id="navGroups" onclick="return window.showAdminView('groups')">Groups</a>
                <a href="#" id="navAttendance" onclick="return window.showAdminView('attendance')">Attendance</a>
                <a href="#" id="navChallenges" onclick="return window.showAdminView('challenges')">Challenges</a>
                <a href="#" id="navStore" onclick="return window.showAdminView('store')">Store/Auctions</a>
                <a href="#" id="navCobros" onclick="return window.showAdminView('cobros')">Cobros</a>
                <a href="#" id="navAnnouncements" onclick="return window.showAdminView('announcements')">Announcements</a>
                <a href="#" id="navFeedback" onclick="return window.showAdminView('feedback')">Feedback</a>
                <a href="#" id="navAdmins" onclick="return window.showAdminView('admins')">Admins</a>
                <button type="button" class="nav-btn" id="btnMute" title="Mute sounds"><i class="bi bi-volume-up"></i></button>
                <button type="button" class="nav-btn" id="btnLogout">Logout</button>
            </nav>

            <!-- VIEW: Dashboard (teacher/admin) -->
            <div id="viewDashboard" class="admin-view">
                <h5 class="mb-3 section-title with-banner"><img src="assets/images/icono-trofeo.webp" class="ui-icon" loading="lazy" alt="Dashboard">Dashboard</h5>
                <div id="teacherDashboardCards" class="row g-3 mb-3"><p class="text-muted small">Loading...</p></div>
                <div id="teacherWalletPanel" class="glass-panel mb-3" style="padding:1rem; display:none;">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h6 class="mb-0">ü™ô Wallet history</h6>
                        <button type="button" class="btn btn-sm btn-outline-light" onclick="window.refreshTeacherWalletHistory && window.refreshTeacherWalletHistory()">Refresh</button>
                    </div>
                    <div id="teacherWalletHistory" class="small text-muted mt-2">Loading...</div>
                </div>
                <div class="glass-panel" style="padding:1rem;">
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="button" class="btn btn-outline-primary" onclick="window.showAdminView('users')">üë©‚Äçüéì Students</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="window.showAdminView('groups')">üè´ Groups</button>
                        <button type="button" class="btn btn-outline-success" onclick="window.showAdminView('attendance')">üìã Attendance</button>
                        <button type="button" class="btn btn-outline-warning" onclick="window.showAdminView('challenges')">‚ö° Challenges</button>
                    </div>
                    <div class="small text-muted mt-2">Tip: pick a group tab in Students to switch between your assigned groups.</div>
                </div>
            </div>

            <!-- VIEW: Institutions (super_admin only) -->
            <div id="viewInstitutions" class="admin-view">
                <h5 class="mb-3 section-title with-banner"><img src="assets/images/icono-trofeo.webp" class="ui-icon" loading="lazy" alt="Institutions">Institutions Control</h5>
                <p class="small text-muted">Manage school plans, AI limits, active teachers, and institution AI credentials.</p>
                <div id="institutionsList"><p class="text-muted small">Loading institutions...</p></div>
            </div>

            <!-- VIEW: Users -->
            <div id="viewUsers" class="admin-view active">
                <h5 class="mb-3 section-title with-banner"><img src="assets/images/icono-trofeo.webp" class="ui-icon" loading="lazy" alt="Users">Manage students</h5>
                <div id="adminQuickStats" class="d-flex flex-wrap gap-3 mb-3">
                    <div class="glass-panel text-center" style="flex:1;min-width:120px;padding:0.75rem 1rem;">
                        <div style="font-size:1.5rem;font-weight:800;color:var(--gold-500);" class="stat-number" id="statTotalStudents">‚Äî</div>
                        <div class="small text-muted">Students</div>
                    </div>
                    <div class="glass-panel text-center" style="flex:1;min-width:120px;padding:0.75rem 1rem;">
                        <div style="font-size:1.5rem;font-weight:800;color:#10b981;" class="stat-number" id="statActiveChallenges">‚Äî</div>
                        <div class="small text-muted">Active Challenges</div>
                    </div>
                    <div class="glass-panel text-center" style="flex:1;min-width:120px;padding:0.75rem 1rem;">
                        <div style="font-size:1.5rem;font-weight:800;color:#fbbf24;" class="stat-number" id="statTotalCoins">‚Äî</div>
                        <div class="small text-muted">Coins in circulation</div>
                    </div>
                </div>
                <p class="small text-muted">Filter students by group and search by name or document ID.</p>
                <div class="d-flex flex-wrap gap-2 mb-3" id="teacherGroupTabs" style="display:none;"></div>
                <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                    <label class="mb-0">Group:</label>
                    <select id="adminGroupFilter" class="form-select" style="max-width: 180px;">
                        <option value="">All groups</option>
                    </select>
                    <input type="text" id="studentSearch" class="form-control" style="max-width:220px;" placeholder="Search name or document">
                    <button type="button" class="btn btn-primary" id="btnRefreshUsers">Refresh</button>
                    <div class="d-flex align-items-center gap-2">
                        <input type="text" id="newGroupCode" class="form-control" placeholder="New group code" style="width: 140px;">
                        <button type="button" class="btn btn-success" id="btnCreateGroup">Create group</button>
                    </div>
                </div>
                <div id="bulkImportPanel" class="glass-panel mb-3" style="padding:1rem;display:none;">
                    <div class="small badge-role mb-2" style="display:inline-flex;background:var(--gold-500);color:#000;">Bulk CSV Import</div>
                    <p class="small text-muted mb-2">CSV format: <code>nombre_completo,documento_id,pin,grupo</code> (header required). Groups auto-created if missing.</p>
                    <input type="file" id="csvFileInput" class="form-control mb-2" accept=".csv,.txt">
                    <button type="button" class="btn btn-warning btn-sm" id="btnRunBulkImport"><i class="bi bi-upload"></i> Import Students</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="document.getElementById('bulkImportPanel').style.display='none'">Cancel</button>
                    <div id="bulkImportStatus" class="mt-2 small"></div>
                </div>
                <div class="mb-2">
                    <button type="button" class="btn btn-outline-info btn-sm" id="btnShowBulkImport"><i class="bi bi-file-earmark-spreadsheet"></i> Bulk Import CSV</button>
                </div>
                <div id="contentUsers">
                    <p class="text-muted">Loading students...</p>
                </div>
            </div>

            <!-- VIEW: Attendance -->
            <div id="viewAttendance" class="admin-view">
                <h5 class="mb-3 section-title"><img src="assets/images/icono-asistencia.webp" class="ui-icon" loading="lazy" alt="Attendance">Attendance & QR</h5>
                <p class="small text-muted">Select a group first. Generate a QR session plus a manual code. Geolocation is optional.</p>
                <div class="mb-3">
                    <label class="form-label">Group (required):</label>
                    <select id="qrGroup" class="form-select" style="max-width: 200px;">
                        <option value="">Select group</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary mb-2" id="btnGenerateQR">Generate Attendance Session (QR + code)</button>
                <div id="qrError" class="alert alert-danger mt-2" style="display: none;"></div>
                <div id="qrcode"></div>
                <div id="manualAttendanceCodeWrap" class="mt-3" style="display:none;">
                    <label class="form-label mb-1">Manual attendance code (same session as QR):</label>
                    <div class="input-group" style="max-width: 520px;">
                        <input type="text" id="manualAttendanceCode" class="form-control" readonly>
                        <button type="button" class="btn btn-outline-secondary" id="btnCopyAttendanceCode">Copy</button>
                    </div>
                    <div class="small text-muted mt-1">Students can open attendance page and enter this code manually if camera scan fails.</div>
                </div>
                <div class="mt-4">
                    <h6 class="mb-2">Who checked in today (this group)</h6>
                    <div id="attendanceTodayList"><p class="text-muted small">Select a group to see list.</p></div>
                </div>
                <div class="mt-3">
                    <h6 class="mb-2">Session attendance (last 30 days)</h6>
                    <div id="attendanceSessionSummary"><p class="text-muted small">Select a group to see attended vs absent by session.</p></div>
                </div>
                <button type="button" class="btn btn-success mt-2" id="btnExportCSV">Export today's attendance (CSV)</button>
            </div>

            <!-- VIEW: Groups -->
            <div id="viewGroups" class="admin-view">
                <h5 class="mb-3">Manage Groups</h5>
                <p class="small text-muted">Create, edit, and delete groups.</p>
                <div class="d-flex gap-2 mb-3" id="groupCreateControls">
                    <input type="text" id="newGroupCodeInput" class="form-control" placeholder="New group code" style="max-width:200px;">
                    <input type="number" id="newGroupCapacity" class="form-control" placeholder="Max capacity" style="max-width:150px;" min="1">
                    <button type="button" class="btn btn-success" id="btnCreateGroupView">Create Group</button>
                </div>
                <div class="small text-muted mb-2">Tip: edit lets you change code, capacity and geofence coordinates.</div>
                <div id="groupsList"><p class="text-muted small">Loading...</p></div>
            </div>

            <!-- VIEW: Challenges -->
            <div id="viewChallenges" class="admin-view">
                <h5 class="mb-3 section-title with-banner"><img src="assets/images/icono-challenge.webp" class="ui-icon" loading="lazy" alt="Challenges">English Challenges</h5>
                <p class="small text-muted">Build challenges like a form: add multiple questions, set correct answers, then publish once.</p>
                <div class="mb-3">
                    <div class="small badge-role mb-2" style="display:inline-flex;">Step 1: Metadata</div>
                    <div class="mb-2">
                        <label class="form-label">Challenge Title</label>
                        <input type="text" id="challengeTitle" class="form-control" placeholder="Example: Unit 2 Grammar Sprint">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Challenge Description</label>
                        <textarea id="challengeDescription" class="form-control" placeholder="Brief instructions for students" rows="2"></textarea>
                    </div>
                    <div class="mb-2">
                        <div class="small badge-role mb-2" style="display:inline-flex;">Step 2: Scope & Target</div>
                        <label class="form-label">Challenge Scope</label>
                        <select id="challengeScope" class="form-select">
                            <option value="all">For all groups</option>
                            <option value="group">For one specific group</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Target Group</label>
                        <select id="challengeTargetGroup" class="form-select" style="display:none;">
                            <option value="">Select target group</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="small badge-role" style="display:inline-flex;">Step 3: Build Questions</div>
                        <h6 class="mb-0">Questions</h6>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddChallengeQuestion"><i class="bi bi-plus-circle"></i> Add Question</button>
                    </div>
                    <div id="challengeQuestionsBuilder"></div>
                    <div class="d-flex gap-2 flex-wrap align-items-center">
                        <button type="button" class="btn btn-primary" id="btnCreateChallenge">Create Challenge</button>
                        <span class="text-muted small">or</span>
                        <button type="button" class="btn btn-outline-warning" id="btnGenerateAI"><i class="bi bi-stars"></i> Generate with AI</button>
                    </div>
                    <div id="aiGeneratePanel" class="glass-panel mt-3" style="display:none;padding:1rem;">
                        <div class="row g-3">
                            <div class="col-md-7">
                                <div class="small badge-role mb-2" style="display:inline-flex;background:var(--gold-500);color:#000;">AI Structured Generator</div>
                                <div class="d-flex gap-2 mb-2">
                                    <div style="flex:1;">
                                        <label class="form-label">CEFR Level</label>
                                        <select id="aiCefrLevel" class="form-select">
                                            <option value="A1">A1</option><option value="A1+">A1+</option>
                                            <option value="A2">A2</option><option value="A2+">A2+</option>
                                            <option value="B1-">B1-</option><option value="B1" selected>B1</option><option value="B1+">B1+</option>
                                            <option value="B2">B2</option><option value="B2+">B2+</option>
                                            <option value="C1">C1</option><option value="C1+">C1+</option>
                                        </select>
                                    </div>
                                    <div style="flex:1;">
                                        <label class="form-label">Skill</label>
                                        <select id="aiSkill" class="form-select">
                                            <option value="Grammar">Grammar</option>
                                            <option value="Vocabulary">Vocabulary</option>
                                            <option value="Speaking">Speaking</option>
                                            <option value="Reading">Reading</option>
                                            <option value="Listening">Listening</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="d-flex gap-2 mb-2">
                                    <div style="flex:1;">
                                        <label class="form-label">Role</label>
                                        <input type="text" id="aiRole" class="form-control" placeholder="e.g. Tourist, Engineer, Student">
                                    </div>
                                    <div style="flex:1;">
                                        <label class="form-label">Context</label>
                                        <input type="text" id="aiContext" class="form-control" placeholder="e.g. Airport, Software Demo">
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Topic</label>
                                    <input type="text" id="aiTopic" class="form-control" placeholder="e.g. Past Perfect, Conditionals, Job Interview">
                                </div>
                                <div class="d-flex gap-2 mb-2">
                                    <div style="flex:1;">
                                        <label class="form-label">Questions</label>
                                        <input type="number" id="aiQuestionCount" class="form-control" value="5" min="1" max="20">
                                    </div>
                                    <div id="aiProviderWrap" style="flex:1;display:none;"></div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">AI Credentials</label>
                                    <div class="form-text">AI provider and API key are managed centrally by super_admin per institution.</div>
                                </div>
                                <button type="button" class="btn btn-warning" id="btnRunStructuredAI"><i class="bi bi-stars"></i> Generar Reto (Costo: 3 Creditos)</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="document.getElementById('aiGeneratePanel').style.display='none'">Cancel</button>
                                <div id="aiGenerateStatus" class="mt-2"></div>
                            </div>
                            <div class="col-md-5">
                                <div id="drako-panel" style="background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.25);border-radius:12px;padding:1rem;min-height:200px;">
                                    <div class="text-center mb-2" style="font-size:2.5rem;line-height:1;">&#x1F409;</div>
                                    <div class="text-center fw-bold mb-2" style="color:var(--gold-500,#FFD700);">Drako</div>
                                    <div id="drako-message" class="small text-center" style="color:#ccc;min-height:40px;">Cargando creditos...</div>
                                    <hr style="border-color:rgba(255,215,0,0.2);margin:0.75rem 0;">
                                    <div id="drako-credits" class="text-center small fw-bold" style="color:var(--gold-500,#FFD700);">...</div>
                                    <div id="aiUsageInfo" class="text-center small text-muted mt-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="challengesList"><p class="text-muted small">Loading...</p></div>
            </div>

            <!-- VIEW: Store / Auctions -->
            <div id="viewStore" class="admin-view">
                <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 auction-header mb-2">
                    <div>
                        <h5 class="mb-2 section-title auction-banner"><img src="assets/images/icono-tienda.webp" class="ui-icon" loading="lazy" alt="Store">Store / Auctions</h5>
                        <div class="store-decor">
                            <img src="assets/images/cofre-tesoro.webp" loading="lazy" alt="Treasure chest">
                            <img src="assets/images/corona-flotante.webp" loading="lazy" alt="Floating crown">
                            <img src="assets/images/icono-moneda.webp" loading="lazy" alt="Coins icon">
                        </div>
                    </div>
                </div>
                <p class="small text-muted">Publish either a Store Item (fixed price) or an Auction Item (bidding).</p>
                <div class="row g-2 mb-3">
                    <div class="col-md-3"><label class="form-label small mb-1">Mode</label><select id="auctionItemType" class="form-select"><option value="auction">Auction Item (Bidding)</option><option value="shop">Store Item (Fixed price)</option></select></div>
                    <div class="col-md-3"><label class="form-label small mb-1">Item Name</label><input type="text" id="auctionItemName" class="form-control" placeholder="Virtual reward name"></div>
                    <div class="col-md-2"><label class="form-label small mb-1">Price / Starting Bid</label><input type="number" id="auctionBasePrice" class="form-control" placeholder="Coins" min="0"></div>
                    <div class="col-md-2"><label class="form-label small mb-1">Group Target</label><select id="auctionGroup" class="form-select"><option value="">All groups</option></select></div>
                    <div class="col-md-2"><label class="form-label small mb-1">Stock (Shop only)</label><input type="number" id="auctionStock" class="form-control" placeholder="Units" min="1" value="1"></div>
                    <div class="col-md-2"><label class="form-label small mb-1">Duration (Auction)</label><input type="number" id="auctionDuration" class="form-control" placeholder="Seconds" min="30" value="120"></div>
                    <div class="col-md-4"><label class="form-label small mb-1">Virtual Reward Description</label><input type="text" id="auctionDescription" class="form-control" placeholder="What student receives"></div>
                    <div class="col-md-3"><button type="button" class="btn btn-primary w-100" id="btnCreateAuction">Publish Item</button></div>
                </div>
                <div id="auctionList"><p class="text-muted small">Loading...</p></div>
            </div>

            <!-- VIEW: Cobros (Billing) -->
            <div id="viewCobros" class="admin-view">
                <h5 class="mb-3">Cobros (Billing Claims)</h5>
                <p class="small text-muted">Students who used rewards from their Bag. Items move to pending delivery here until you confirm delivered.</p>
                <div id="billingClaimsList"><p class="text-muted small">Loading...</p></div>
            </div>

            <!-- VIEW: Announcements -->
            <div id="viewAnnouncements" class="admin-view">
                <h5 class="mb-3 section-title"><img src="assets/images/icono-challenge.webp" class="ui-icon" loading="lazy" alt="Announcements">Announcements</h5>
                <p class="small text-muted">Create alert-style messages with optional resource links.</p>
                <div class="mb-3">
                    <input type="hidden" id="announcementEditId">
                    <label class="form-label">Title</label>
                    <input type="text" id="announcementTitle" class="form-control mb-2" placeholder="Announcement title">
                    <label class="form-label">Message</label>
                    <textarea id="announcementMessage" class="form-control mb-2" placeholder="Announcement message" rows="3"></textarea>
                    <label class="form-label">Alert Type</label>
                    <select id="announcementType" class="form-select mb-2">
                        <option value="info">Info</option>
                        <option value="success">Success</option>
                        <option value="warning">Warning</option>
                        <option value="danger">Danger</option>
                    </select>
                    <label class="form-label">Links</label>
                    <textarea id="announcementLinks" class="form-control mb-2" rows="2" placeholder="One per line: Label|https://url"></textarea>
                    <label class="form-label">Target Group</label>
                    <select id="announcementGroup" class="form-select mb-2">
                        <option value="">All groups</option>
                    </select>
                    <label class="form-label">Expiry Date</label>
                    <input type="date" id="announcementExpiry" class="form-control mb-2">
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" id="btnCreateAnnouncement">Create Announcement</button>
                        <button type="button" class="btn btn-outline-secondary" id="btnCancelAnnouncementEdit" style="display:none;">Cancel Edit</button>
                    </div>
                </div>
                <div id="announcementsList"><p class="text-muted small">Loading...</p></div>
            </div>

            <!-- VIEW: Feedback -->
            <div id="viewFeedback" class="admin-view">
                <h5 class="mb-3 section-title"><img src="assets/images/icono-trofeo.webp" class="ui-icon" loading="lazy" alt="Feedback">Student Feedback</h5>
                <p class="small text-muted">Review and manage student feedback messages.</p>
                <div id="feedbackList"><p class="text-muted small">Loading...</p></div>
            </div>

            <!-- VIEW: Admins (super_admin only) -->
            <div id="viewAdmins" class="admin-view">
                <h5 class="mb-3 section-title"><img src="assets/images/rey-con-dragon.webp" class="ui-icon" loading="lazy" alt="Admin">Admin Management</h5>
                <p class="small text-muted">Create and review teacher/admin accounts.</p>
                <div id="adminCreateBlock" class="glass-panel mb-3" style="padding:1rem;">
                    <div class="row g-2">
                        <div class="col-md-3"><input type="text" id="newAdminName" class="form-control" placeholder="Full name"></div>
                        <div class="col-md-2"><input type="text" id="newAdminDoc" class="form-control" placeholder="Document"></div>
                        <div class="col-md-2"><input type="password" id="newAdminPin" class="form-control" placeholder="PIN"></div>
                        <div class="col-md-2"><select id="newAdminRole" class="form-select"><option value="teacher">teacher</option><option value="admin">admin</option></select></div>
                        <div class="col-md-3"><button type="button" class="btn btn-primary w-100" id="btnCreateAdminUser">Create Admin User</button></div>
                    </div>
                </div>
                <div id="adminUsersList"><p class="text-muted small">Loading...</p></div>
                <div id="transferCreditsBlock" class="glass-panel mt-3" style="padding:1rem;">
                    <h6 class="mb-2"><i class="bi bi-coin"></i> Transfer Credits to Teacher</h6>
                    <p class="small text-muted mb-2">Transfer AI credits from institution pool to a teacher's personal balance.</p>
                    <div class="row g-2">
                        <div class="col-md-5"><select id="transferTeacherSelect" class="form-select"><option value="">Select teacher...</option></select></div>
                        <div class="col-md-3"><input type="number" id="transferAmount" class="form-control" placeholder="Amount" min="1" value="10"></div>
                        <div class="col-md-4"><button type="button" class="btn btn-warning w-100" id="btnTransferCredits"><i class="bi bi-send"></i> Transfer Credits</button></div>
                    </div>
                    <div id="transferCreditsStatus" class="mt-2 small"></div>
                </div>
                <div id="llmAssignBlock" class="glass-panel mt-3" style="padding:1rem;">
                    <h6 class="mb-2"><i class="bi bi-cpu"></i> LLM Provider Assignment</h6>
                    <p class="small text-muted mb-2">Assign AI provider per institution. Teachers cannot override this.</p>
                    <div class="row g-2">
                        <div class="col-md-5">
                            <select id="llmProviderSelect" class="form-select">
                                <option value="chatgpt">ChatGPT (OpenAI)</option>
                                <option value="claude">Claude (Anthropic)</option>
                                <option value="gemini">Gemini (Google)</option>
                            </select>
                        </div>
                        <div class="col-md-4"><button type="button" class="btn btn-info w-100" id="btnAssignLLM"><i class="bi bi-cpu"></i> Assign LLM</button></div>
                    </div>
                    <div id="llmAssignStatus" class="mt-2 small"></div>
                </div>
                <div id="overrideCreditsBlock" class="glass-panel mt-3" style="padding:1rem;">
                    <h6 class="mb-2"><i class="bi bi-shield-lock"></i> Override Credits (God Mode)</h6>
                    <p class="small text-muted mb-2">Directly set institution pool or teacher credits.</p>
                    <div class="row g-2 mb-2">
                        <div class="col-md-4"><label class="form-label small">Institution Pool</label><input type="number" id="overrideInstPool" class="form-control" placeholder="New pool" min="0"></div>
                        <div class="col-md-4"><label class="form-label small">Institution Used</label><input type="number" id="overrideInstUsed" class="form-control" placeholder="New used" min="0"></div>
                        <div class="col-md-4 d-flex align-items-end"><button type="button" class="btn btn-danger w-100" id="btnOverrideInstCredits">Override Institution</button></div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-5"><select id="overrideTeacherSelect" class="form-select"><option value="">Select teacher...</option></select></div>
                        <div class="col-md-3"><input type="number" id="overrideTeacherCredits" class="form-control" placeholder="New credits" min="0"></div>
                        <div class="col-md-4"><button type="button" class="btn btn-danger w-100" id="btnOverrideTeacherCredits">Override Teacher</button></div>
                    </div>
                    <div id="overrideCreditsStatus" class="mt-2 small"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="giveCoinsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Give ü™ô Coins</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="giveCoinsStudentId">
                    <div class="mb-2"><label class="form-label">Student</label><input type="text" id="giveCoinsStudentName" class="form-control" readonly></div>
                    <div class="mb-2"><label class="form-label">Amount</label><input type="number" id="giveCoinsAmount" class="form-control" min="1" step="1" placeholder="e.g. 40"></div>
                    <div class="mb-2"><label class="form-label">Reason</label><input type="text" id="giveCoinsReason" class="form-control" maxlength="180" placeholder="Required reason"></div>
                    <div id="giveCoinsStatus" class="small mt-2"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-warning" id="btnConfirmGiveCoins">Give Coins</button></div>
            </div>
        </div>
    </div>
    <div class="text-center small text-muted mt-2 mb-3">v1.0-MVP-STABLE</div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer" style="z-index:1080;"></div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Edit user</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="editProfileId">
                    <div class="mb-3"><label class="form-label">Full name (nombre_completo)</label><input type="text" id="editName" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">Document ID</label><input type="text" id="editDoc" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">PIN</label><input type="password" id="editPin" class="form-control" placeholder="Leave blank to keep current"></div>
                    <div class="mb-3" id="editRoleWrap"><label class="form-label">Role</label><select id="editRole" class="form-select"><option value="student">student</option><option value="admin">admin</option></select></div>
                    <div class="mb-3"><label class="form-label">Group</label><select id="editGroup" class="form-select"></select></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="btnSaveEdit">Save</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="groupEditModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Edit Group</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="editGroupOldCode">
                    <div class="mb-2"><label class="form-label">Group code</label><input type="text" id="editGroupCode" class="form-control"></div>
                    <div class="mb-2"><label class="form-label">Student limit</label><input type="number" id="editGroupCapacity" class="form-control" min="1"></div>
                    <div class="mb-2"><label class="form-label">Last admin latitude</label><input type="number" id="editGroupLat" class="form-control" step="any"></div>
                    <div class="mb-2"><label class="form-label">Last admin longitude</label><input type="number" id="editGroupLng" class="form-control" step="any"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="btnSaveGroupEdit">Save</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalImprovementPlan" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">üéØ Asignar Plan de Mejora</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="improvementStudentId">
                    <div class="mb-3"><label class="form-label">Student</label><input type="text" id="improvementStudentName" class="form-control" readonly></div>
                    <div class="mb-3"><label class="form-label">Critical Topic</label><input type="text" id="improvementTopic" class="form-control" placeholder="e.g. Past Perfect, Conditionals"></div>
                    <div class="mb-3"><label class="form-label">Entry Cost (coins)</label><input type="number" id="improvementEntryCost" class="form-control" value="5" min="0"></div>
                    <div class="mb-3"><label class="form-label">Reward on Completion (coins)</label><input type="number" id="improvementReward" class="form-control" value="50" min="0"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-warning" id="btnSubmitImprovementPlan">Emitir Plan</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs2@0.0.2/qrcode.min.js"></script>
    <script src="./config.js"></script>
    <script src="./app.js"></script>
    <script src="./modules/auth.js"></script>
    <script src="./modules/ui.js"></script>
    <script src="./modules/users.js"></script>
    <script src="./modules/attendance.js"></script>
    <script src="./modules/challenges.js"></script>
    <script src="./modules/store.js"></script>
    <script src="./modules/announcements.js"></script>
    <script src="./modules/feedback.js"></script>
    <script>
// SAFE localStorage parsing with try/catch - BEFORE DOMContentLoaded
var user = (window.Auth && typeof window.Auth.guardRole === 'function')
    ? Auth.guardRole(['teacher', 'admin'], 'index.html')
    : null;
try {
    if (!user) user = JSON.parse(localStorage.getItem('lingoCoins_user') || '{}');
} catch (e) {
    console.error('[ADMIN] Failed to parse user data:', e);
    localStorage.removeItem('lingoCoins_user');
    window.location.href = 'index.html';
}
// School admins operate from admin.html (not teacher.html)
if (user && String(user.rol || '') === 'admin') {
    window.location.href = 'admin.html';
}

if (!user || !user.id || ['teacher'].indexOf(String(user.rol || '')) === -1) {
    console.warn('[ADMIN] Not authorized, redirecting to login');
    window.location.href = 'index.html';
}
var isSuperAdmin = false;
var isSchoolAdmin = String((user && user.rol) || '') === 'admin';
var isTeacherRole = String((user && user.rol) || '') === 'teacher';

// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('[ADMIN] DOM loaded, initializing admin panel...');
    console.log('[ADMIN] User:', user.nombre_completo, '| Role:', user.rol);
    
    document.getElementById('adminName').textContent = user.nombre_completo || 'Admin';

    var reduceMotion = false;
    try { reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; } catch (_) {}

    var SOUND_KEY = 'lingoCoins_muted';
    var isMuted = false;
    try { isMuted = localStorage.getItem(SOUND_KEY) === '1'; } catch (_) {}
    var audioCtx = null;
    var soundReady = false;

    function setMute(nextMuted) {
        isMuted = !!nextMuted;
        try { localStorage.setItem(SOUND_KEY, isMuted ? '1' : '0'); } catch (_) {}
        var btn = document.getElementById('btnMute');
        if (btn) btn.innerHTML = isMuted ? '<i class="bi bi-volume-mute"></i>' : '<i class="bi bi-volume-up"></i>';
    }

    function ensureAudioContext() {
        if (audioCtx) return audioCtx;
        var Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return null;
        audioCtx = new Ctx();
        return audioCtx;
    }

    function markSoundReady() {
        soundReady = true;
        var ctx = ensureAudioContext();
        if (!ctx) return;
        if (ctx.state === 'suspended') ctx.resume().catch(function(){});
    }

    function withOsc(freq, type, durSec, gainPeak, whenSec) {
        if (isMuted || !soundReady || reduceMotion) return;
        var ctx = ensureAudioContext();
        if (!ctx) return;
        var now = ctx.currentTime + (whenSec || 0);
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.type = type || 'sine';
        osc.frequency.setValueAtTime(Math.max(40, freq || 440), now);
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(Math.max(0.0001, gainPeak || 0.06), now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + Math.max(0.05, durSec || 0.25));
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(now);
        osc.stop(now + Math.max(0.05, durSec || 0.25) + 0.02);
    }

    function playCoinSound() {
        if (isMuted || !soundReady) return;
        var ctx = ensureAudioContext();
        if (!ctx) return;
        var now = ctx.currentTime;
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(740, now);
        osc.frequency.exponentialRampToValueAtTime(990, now + 0.12);
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(0.05, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.26);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(now);
        osc.stop(now + 0.28);
    }
    function playBadgeUnlock() { withOsc(440, 'sine', 0.18, 0.045, 0.0); withOsc(554, 'sine', 0.18, 0.045, 0.08); withOsc(659, 'sine', 0.22, 0.05, 0.16); }

    (function setupSoundGate() {
        var once = false;
        function unlock() {
            if (once) return;
            once = true;
            markSoundReady();
            window.removeEventListener('pointerdown', unlock, true);
            window.removeEventListener('keydown', unlock, true);
            window.removeEventListener('touchstart', unlock, true);
        }
        window.addEventListener('pointerdown', unlock, true);
        window.addEventListener('keydown', unlock, true);
        window.addEventListener('touchstart', unlock, true);
    })();

    setMute(isMuted);
    var muteBtn = document.getElementById('btnMute');
    if (muteBtn) {
        muteBtn.addEventListener('click', function() {
            setMute(!isMuted);
        });
    }

    function animateNumber(el, nextValue, durationMs) {
        if (!el) return;
        var end = Math.max(0, Math.floor(Number(nextValue)) || 0);
        var start = Math.max(0, Math.floor(Number(el.getAttribute('data-last-num') || el.textContent)) || 0);
        el.setAttribute('data-last-num', String(end));
        if (reduceMotion) { el.textContent = String(end); return; }
        if (start === end) { el.textContent = String(end); return; }
        var dur = Math.max(150, Number(durationMs) || 900);
        var t0 = null;
        function step(ts) {
            if (t0 == null) t0 = ts;
            var p = Math.min((ts - t0) / dur, 1);
            var eased = 1 - Math.pow(1 - p, 3);
            el.textContent = String(Math.round(start + (end - start) * eased));
            if (p < 1) requestAnimationFrame(step);
            else el.textContent = String(end);
        }
        requestAnimationFrame(step);
    }

    function bumpStat(el) {
        if (!el || reduceMotion) return;
        el.classList.remove('admin-stat-unlock');
        void el.offsetWidth;
        el.classList.add('admin-stat-unlock');
        window.setTimeout(function(){ el.classList.remove('admin-stat-unlock'); }, 800);
    }

    function attachCountUp(id, opts) {
        var el = document.getElementById(id);
        if (!el) return;
        var last = null;
        var obs = new MutationObserver(function() {
            var raw = String(el.textContent || '').replace(/[^0-9]/g, '');
            var next = raw ? Number(raw) : 0;
            if (!Number.isFinite(next)) return;
            if (last == null) {
                last = next;
                el.textContent = '0';
                animateNumber(el, next, 1200);
                return;
            }
            if (next !== last) {
                var prev = last;
                last = next;
                el.textContent = String(prev);
                animateNumber(el, next, 700);
                bumpStat(el);
                if (opts && opts.sound && next > prev) opts.sound();
                if (opts && opts.fanfare && next > prev) opts.fanfare();
            }
        });
        obs.observe(el, { childList: true, characterData: true, subtree: true });
    }

    attachCountUp('statTotalStudents');
    attachCountUp('statActiveChallenges');
    attachCountUp('statTotalCoins', { sound: playCoinSound, fanfare: playBadgeUnlock });

    // --- Logout: ensure it clears storage and redirects ---
    window.logout = function() {
        localStorage.removeItem('lingoCoins_user');
        window.location.href = 'index.html';
    };

    // --- School admin restrictions (read-only operational panel) ---
    if (isSchoolAdmin) {
        // Attendance: read-only, disable QR/session generation
        var qrBtn = document.getElementById('btnGenerateQR');
        if (qrBtn) {
            qrBtn.disabled = true;
            qrBtn.style.display = 'none';
        }
        var qrWrap = document.getElementById('qrcode');
        if (qrWrap) qrWrap.style.display = 'none';
        var manualWrap = document.getElementById('manualAttendanceCodeWrap');
        if (manualWrap) manualWrap.style.display = 'none';
        var qrErr = document.getElementById('qrError');
        if (qrErr) qrErr.style.display = 'none';

        // Challenges: read-only list. Hide builder + AI generation.
        var viewCh = document.getElementById('viewChallenges');
        var titleInput = document.getElementById('challengeTitle');
        if (viewCh && titleInput && titleInput.closest) {
            var builderBlock = titleInput.closest('.mb-3');
            if (builderBlock) builderBlock.style.display = 'none';
            var intro = viewCh.querySelector('p.small.text-muted');
            if (intro) intro.textContent = 'Review active challenges and their target group. (School admins cannot create or modify challenges.)';
        }
        var aiPanel = document.getElementById('aiGeneratePanel');
        if (aiPanel) aiPanel.style.display = 'none';
        ['btnAddChallengeQuestion', 'btnCreateChallenge', 'btnGenerateAI', 'btnRunStructuredAI'].forEach(function(id) {
            var b = document.getElementById(id);
            if (b) { b.disabled = true; b.style.display = 'none'; }
        });
    }
    document.getElementById('btnLogout').addEventListener('click', window.logout);

    // --- Role-based allowed views ---
    var roleAllowedViews = {
        'admin': ['dashboard', 'users', 'groups', 'attendance', 'challenges', 'announcements'],
        'teacher': ['dashboard', 'users', 'groups', 'attendance', 'challenges', 'announcements']
    };
    var userAllowedViews = roleAllowedViews[user.rol] || roleAllowedViews['teacher'];

    // Hide nav items that this role cannot access
    ['dashboard','institutions','users','groups','attendance','challenges','store','cobros','announcements','feedback','admins'].forEach(function(v) {
        if (userAllowedViews.indexOf(v) === -1) {
            var navEl = document.getElementById('nav' + v.charAt(0).toUpperCase() + v.slice(1));
            if (navEl) navEl.style.display = 'none';
        } else {
            var showNavEl = document.getElementById('nav' + v.charAt(0).toUpperCase() + v.slice(1));
            if (showNavEl) showNavEl.style.display = '';
        }
    });

    // --- SPA view switching (with DOM bypass prevention) ---
    window.showAdminView = function(viewId) {
        if (userAllowedViews.indexOf(viewId) === -1) {
            console.warn('[RBAC] Role "' + user.rol + '" cannot access view: ' + viewId);
            showToast('Access denied for your role', 'danger');
            return false;
        }
        document.querySelectorAll('.admin-view').forEach(function(el) { el.classList.remove('active'); });
        document.querySelectorAll('.admin-nav a').forEach(function(el) { el.classList.remove('active'); });
        var view = document.getElementById('view' + viewId.charAt(0).toUpperCase() + viewId.slice(1));
        var nav = document.getElementById('nav' + viewId.charAt(0).toUpperCase() + viewId.slice(1));
        if (view) view.classList.add('active');
        if (nav) nav.classList.add('active');
        document.body.classList.remove('bg-dashboard', 'bg-challenges', 'bg-store', 'bg-auctions');
        if (viewId === 'challenges') document.body.classList.add('bg-challenges');
        else if (viewId === 'store') document.body.classList.add('bg-auctions');
        else document.body.classList.add('bg-dashboard');
        if (viewId === 'institutions' && typeof window.loadInstitutionsView === 'function') window.loadInstitutionsView();
        if (viewId === 'dashboard') loadTeacherDashboard();
        if (viewId === 'groups') window.loadGroupsList();
        if (viewId === 'attendance') window.refreshAttendanceList();
        if (viewId === 'challenges') window.loadChallengesList();
        if (viewId === 'store') {
            window.loadAuctionList();
            startAdminAuctionPolling();
        } else {
            stopAdminAuctionPolling();
        }
        if (viewId === 'cobros') window.loadBillingClaims();
        if (viewId === 'announcements') window.loadAnnouncementsList();
        if (viewId === 'feedback') window.loadFeedbackList();
        if (viewId === 'admins') window.loadAdminUsers();
        return false;
    };

    var initialAdminView = isTeacherRole ? 'dashboard' : 'users';
    try {
        var requestedView = new URLSearchParams(window.location.search).get('view');
        if (requestedView && userAllowedViews.indexOf(String(requestedView)) !== -1) {
            initialAdminView = String(requestedView);
        }
    } catch (_) {}
    document.body.classList.add('bg-dashboard');

    function getSelectedGroup() {
        var el = document.getElementById('adminGroupFilter');
        return el ? el.value : '';
    }

    function getSelectedQRGroup() {
        var el = document.getElementById('qrGroup');
        return el ? el.value : '';
    }

    function toBase64Url(raw) {
        try {
            return btoa(raw).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
        } catch (_) {
            return '';
        }
    }

    function encodeAttendanceSession(payload) {
        return toBase64Url(JSON.stringify(payload || {}));
    }

    function parseAnnouncementLinks(raw) {
        var lines = String(raw || '').split(/\r?\n/).map(function(x) { return x.trim(); }).filter(Boolean);
        return lines.map(function(line) {
            var parts = line.split('|');
            if (parts.length < 2) return null;
            var label = String(parts[0] || '').trim();
            var url = String(parts.slice(1).join('|') || '').trim();
            if (!label || !/^https?:\/\//i.test(url)) return null;
            return { label: label, url: url, type: 'resource' };
        }).filter(Boolean);
    }

    function parseChallengeOptions(raw) {
        if (Array.isArray(raw)) {
            return raw.map(function(x) { return String(x == null ? '' : x).trim(); }).filter(Boolean);
        }
        return String(raw || '').split(/\r?\n|,/).map(function(x) { return x.trim(); }).filter(Boolean);
    }

    function buildChallengeOptionObjects(optionLabels) {
        var labels = Array.isArray(optionLabels) ? optionLabels : [];
        return labels.map(function(label, idx) {
            return {
                value: 'opt_' + (idx + 1),
                label: String(label || '').trim()
            };
        }).filter(function(opt) {
            return !!opt.label;
        });
    }

    function parseMatchingPairs(raw) {
        var obj = {};
        String(raw || '').split(/\r?\n/).forEach(function(line) {
            var parts = line.split('=');
            if (parts.length < 2) return;
            var k = String(parts[0] || '').trim();
            var v = String(parts.slice(1).join('=') || '').trim();
            if (k && v) obj[k] = v;
        });
        return obj;
    }

    var challengeBuilderState = [];

    function normalizeQuestionTypeAdmin(type) {
        var t = String(type || 'open').trim().toLowerCase();
        if (t === 'true/false' || t === 'boolean') return 'true_false';
        if (t === 'multiple-choice' || t === 'mcq') return 'multiple_choice';
        return t || 'open';
    }

    function defaultChallengeQuestion(type) {
        var qType = normalizeQuestionTypeAdmin(type || 'multiple_choice');
        var model = {
            question_type: qType,
            question_text: '',
            options: [],
            correct_answer: '',
            matching_pairs_text: ''
        };
        if (qType === 'true_false') {
            model.options = ['True', 'False'];
            model.correct_answer = 'true';
        } else if (qType === 'multiple_choice') {
            model.options = ['Option A', 'Option B', 'Option C', 'Option D'];
            model.correct_answer = 'Option A';
        } else if (qType === 'multiple_select') {
            model.options = ['Option A', 'Option B', 'Option C', 'Option D'];
        }
        return model;
    }

    function ensureQuestionModelDefaults(model) {
        if (!model) return defaultChallengeQuestion('open');
        model.question_type = normalizeQuestionTypeAdmin(model.question_type);
        if (!Array.isArray(model.options)) model.options = [];
        model.question_text = String(model.question_text || '');
        model.correct_answer = String(model.correct_answer == null ? '' : model.correct_answer);
        model.matching_pairs_text = String(model.matching_pairs_text || '');
        if (model.question_type === 'true_false') {
            model.options = ['True', 'False'];
            if (!['true', 'false'].includes(String(model.correct_answer).toLowerCase())) model.correct_answer = 'true';
        }
        if ((model.question_type === 'multiple_choice' || model.question_type === 'multiple_select') && model.options.length < 2) {
            model.options = ['Option A', 'Option B', 'Option C', 'Option D'];
        }
        return model;
    }

    function updateQuestionOrderLabels() {
        var cards = document.querySelectorAll('.question-builder-card');
        cards.forEach(function(card, idx) {
            var badge = card.querySelector('[data-question-order]');
            if (badge) badge.textContent = 'Question ' + (idx + 1);
        });
    }

    function renderChallengeBuilder() {
        var wrap = document.getElementById('challengeQuestionsBuilder');
        if (!wrap) return;
        if (!challengeBuilderState.length) challengeBuilderState = [defaultChallengeQuestion('multiple_choice')];
        wrap.innerHTML = challengeBuilderState.map(function(q, idx) {
            var qType = normalizeQuestionTypeAdmin(q.question_type);
            var removeBtn = challengeBuilderState.length > 1
                ? '<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeChallengeQuestion(' + idx + ')"><i class="bi bi-trash"></i> Delete</button>'
                : '';
            var optionsBlock = '';
            if (qType === 'true_false') {
                optionsBlock = '<div class="mb-2"><label class="form-label fw-bold">Options</label><div class="small text-muted">True / False (fixed)</div></div>' +
                    '<div class="mb-2"><label class="form-label fw-bold">Correct Answer</label><select class="form-select" onchange="updateQuestionCorrect(' + idx + ', this.value)"><option value="true" ' + (String(q.correct_answer).toLowerCase() === 'true' ? 'selected' : '') + '>True</option><option value="false" ' + (String(q.correct_answer).toLowerCase() === 'false' ? 'selected' : '') + '>False</option></select></div>';
            } else if (qType === 'multiple_choice') {
                optionsBlock = '<div class="mb-2"><label class="form-label fw-bold">Options</label>' + q.options.map(function(opt, oIdx) {
                    var label = 'Option ' + String.fromCharCode(65 + oIdx);
                    return '<div class="input-group input-group-sm mb-1"><span class="input-group-text">' + label + '</span><input type="text" class="form-control" value="' + escapeAttr(opt || '') + '" oninput="updateQuestionOption(' + idx + ',' + oIdx + ', this.value)"><button type="button" class="btn btn-outline-danger" onclick="removeQuestionOption(' + idx + ',' + oIdx + ')" ' + (q.options.length <= 2 ? 'disabled' : '') + '><i class="bi bi-x"></i></button></div>';
                }).join('') + '<button type="button" class="btn btn-outline-secondary btn-sm" onclick="addQuestionOption(' + idx + ')">+ Add option</button></div>' +
                '<div class="mb-2"><label class="form-label fw-bold">Correct Answer</label><select class="form-select" onchange="updateQuestionCorrect(' + idx + ', this.value)">' + q.options.map(function(opt) {
                    var safe = String(opt || '').trim();
                    return '<option value="' + escapeAttr(safe) + '" ' + (String(q.correct_answer) === safe ? 'selected' : '') + '>' + escapeHtml(safe || '(empty)') + '</option>';
                }).join('') + '</select></div>';
            } else if (qType === 'multiple_select') {
                var correctSelected = parseChallengeOptions(q.correct_answer || '');
                optionsBlock = '<div class="mb-2"><label class="form-label fw-bold">Options</label>' + q.options.map(function(opt, oIdx) {
                    var label = 'Option ' + String.fromCharCode(65 + oIdx);
                    return '<div class="input-group input-group-sm mb-1"><span class="input-group-text">' + label + '</span><input type="text" class="form-control" value="' + escapeAttr(opt || '') + '" oninput="updateQuestionOption(' + idx + ',' + oIdx + ', this.value)"><button type="button" class="btn btn-outline-danger" onclick="removeQuestionOption(' + idx + ',' + oIdx + ')" ' + (q.options.length <= 2 ? 'disabled' : '') + '><i class="bi bi-x"></i></button></div>';
                }).join('') + '<button type="button" class="btn btn-outline-secondary btn-sm" onclick="addQuestionOption(' + idx + ')">+ Add option</button></div>' +
                '<div class="mb-2"><label class="form-label fw-bold">Correct Answers</label><div class="d-flex flex-column gap-1">' + q.options.map(function(opt) {
                    var safeOpt = String(opt || '').trim();
                    if (!safeOpt) return '';
                    var checked = correctSelected.includes(safeOpt) ? 'checked' : '';
                    return '<label class="small"><input type="checkbox" ' + checked + ' onchange="toggleQuestionMultiCorrect(' + idx + ',\'' + escapeAttr(safeOpt) + '\', this.checked)"> ' + escapeHtml(safeOpt) + '</label>';
                }).join('') + '</div><div class="form-text">Select all valid options (exact set required).</div></div>';
            } else if (qType === 'matching') {
                optionsBlock = '<div class="mb-2"><label class="form-label fw-bold">Correct Answer</label><textarea class="form-control" rows="3" placeholder="One pair per line: Term=Definition" oninput="updateQuestionPairs(' + idx + ', this.value)">' + escapeHtml(q.matching_pairs_text || '') + '</textarea></div>';
            } else if (qType === 'fill_blank') {
                optionsBlock = '<div class="mb-2"><label class="form-label fw-bold">Correct Answer</label><input type="text" class="form-control" value="' + escapeAttr(q.correct_answer || '') + '" placeholder="Accepted blanks, separated by comma" oninput="updateQuestionCorrect(' + idx + ', this.value)"></div>';
            } else {
                optionsBlock = '<div class="mb-2"><label class="form-label fw-bold">Correct Answer</label><input type="text" class="form-control" value="' + escapeAttr(q.correct_answer || '') + '" placeholder="Accepted answer(s), separated by comma" oninput="updateQuestionCorrect(' + idx + ', this.value)"></div>';
            }
            return '<div class="question-builder-card"><div class="card-title-row"><strong data-question-order>Question ' + (idx + 1) + '</strong>' + removeBtn + '</div>' +
                '<div class="mb-2"><label class="form-label fw-bold">Question Type</label><select class="form-select" onchange="updateQuestionType(' + idx + ', this.value)">' +
                '<option value="open" ' + (qType === 'open' ? 'selected' : '') + '>Open Answer</option>' +
                '<option value="true_false" ' + (qType === 'true_false' ? 'selected' : '') + '>True / False</option>' +
                '<option value="multiple_choice" ' + (qType === 'multiple_choice' ? 'selected' : '') + '>Multiple Choice</option>' +
                '<option value="multiple_select" ' + (qType === 'multiple_select' ? 'selected' : '') + '>Multiple Select</option>' +
                '<option value="matching" ' + (qType === 'matching' ? 'selected' : '') + '>Matching</option>' +
                '<option value="fill_blank" ' + (qType === 'fill_blank' ? 'selected' : '') + '>Fill in the Blank</option>' +
                '</select></div>' +
                '<div class="mb-2"><label class="form-label fw-bold">Question</label><textarea class="form-control" rows="2" placeholder="Write the question" oninput="updateQuestionText(' + idx + ', this.value)">' + escapeHtml(q.question_text || '') + '</textarea></div>' +
                optionsBlock +
                '</div>';
        }).join('');
        updateQuestionOrderLabels();
    }

    window.addChallengeQuestion = function(type) {
        challengeBuilderState.push(defaultChallengeQuestion(type || 'multiple_choice'));
        renderChallengeBuilder();
    };
    window.removeChallengeQuestion = function(index) {
        challengeBuilderState.splice(index, 1);
        if (!challengeBuilderState.length) challengeBuilderState = [defaultChallengeQuestion('multiple_choice')];
        renderChallengeBuilder();
    };
    window.updateQuestionType = function(index, newType) {
        var next = defaultChallengeQuestion(newType);
        next.question_text = challengeBuilderState[index].question_text || '';
        challengeBuilderState[index] = next;
        renderChallengeBuilder();
    };
    window.updateQuestionText = function(index, value) {
        challengeBuilderState[index].question_text = String(value || '');
    };
    window.updateQuestionOption = function(index, optIndex, value) {
        var oldValue = String(challengeBuilderState[index].options[optIndex] || '').trim();
        var nextValue = String(value || '');
        challengeBuilderState[index].options[optIndex] = String(value || '');
        var q = challengeBuilderState[index];
        var qType = normalizeQuestionTypeAdmin(q.question_type);
        if (qType === 'multiple_choice' && oldValue && String(q.correct_answer).trim() === oldValue) {
            q.correct_answer = nextValue.trim();
        }
        if (qType === 'multiple_select' && oldValue && oldValue !== nextValue.trim()) {
            var selected = parseChallengeOptions(q.correct_answer || '');
            selected = selected.map(function(x) { return x === oldValue ? nextValue.trim() : x; }).filter(Boolean);
            q.correct_answer = selected.join(',');
        }
    };
    window.addQuestionOption = function(index) {
        challengeBuilderState[index].options.push('');
        renderChallengeBuilder();
    };
    window.removeQuestionOption = function(index, optIndex) {
        challengeBuilderState[index].options.splice(optIndex, 1);
        renderChallengeBuilder();
    };
    window.updateQuestionCorrect = function(index, value) {
        challengeBuilderState[index].correct_answer = String(value == null ? '' : value);
    };
    window.toggleQuestionMultiCorrect = function(index, optionLabel, checked) {
        var q = challengeBuilderState[index];
        var selected = parseChallengeOptions(q.correct_answer || '');
        var opt = String(optionLabel || '').trim();
        if (!opt) return;
        if (checked) {
            if (!selected.includes(opt)) selected.push(opt);
        } else {
            selected = selected.filter(function(x) { return x !== opt; });
        }
        q.correct_answer = selected.join(',');
    };
    window.updateQuestionPairs = function(index, value) {
        challengeBuilderState[index].matching_pairs_text = String(value || '');
    };

    function collectChallengeQuestionsForSave() {
        var out = [];
        for (var i = 0; i < challengeBuilderState.length; i++) {
            var q = ensureQuestionModelDefaults(challengeBuilderState[i]);
            var qType = normalizeQuestionTypeAdmin(q.question_type);
            var qText = String(q.question_text || '').trim();
            if (!qText) throw new Error('Question ' + (i + 1) + ': question text is required');

            var model = {
                question_type: qType,
                question_text: qText,
                payload: {},
                correct_answer: ''
            };

            if (qType === 'true_false') {
                var tf = String(q.correct_answer || 'true').toLowerCase() === 'false' ? 'false' : 'true';
                model.payload = { options: ['True', 'False'], correct_answer: tf };
                model.correct_answer = tf;
            } else if (qType === 'multiple_choice') {
                var options = q.options.map(function(x) { return String(x || '').trim(); }).filter(Boolean);
                if (options.length < 2) throw new Error('Question ' + (i + 1) + ': add at least 2 options');
                var correct = String(q.correct_answer || '').trim();
                if (!correct || !options.includes(correct)) throw new Error('Question ' + (i + 1) + ': correct answer must match one option');
                var optionObjects = buildChallengeOptionObjects(options);
                var correctOption = optionObjects.find(function(opt) { return opt.label === correct; });
                if (!correctOption) throw new Error('Question ' + (i + 1) + ': correct answer must match one option');
                model.payload = { options: optionObjects, correct_answer: correctOption.value };
                model.correct_answer = correctOption.value;
            } else if (qType === 'multiple_select') {
                var multiOpts = q.options.map(function(x) { return String(x || '').trim(); }).filter(Boolean);
                var multiCorrect = parseChallengeOptions(q.correct_answer || '');
                if (multiOpts.length < 2) throw new Error('Question ' + (i + 1) + ': add at least 2 options');
                if (!multiCorrect.length) throw new Error('Question ' + (i + 1) + ': add at least one correct option');
                var invalidCorrect = multiCorrect.filter(function(x) { return !multiOpts.includes(x); });
                if (invalidCorrect.length) throw new Error('Question ' + (i + 1) + ': correct answers must exist in options');
                var multiOptionObjects = buildChallengeOptionObjects(multiOpts);
                var multiValues = multiOptionObjects
                    .filter(function(opt) { return multiCorrect.includes(opt.label); })
                    .map(function(opt) { return opt.value; });
                model.payload = { options: multiOptionObjects, correct_answers: multiValues };
                model.correct_answer = multiValues.join(',');
            } else if (qType === 'matching') {
                var pairs = parseMatchingPairs(q.matching_pairs_text || '');
                if (!Object.keys(pairs).length) throw new Error('Question ' + (i + 1) + ': add matching pairs using Term=Definition');
                model.payload = { pairs: pairs };
                model.correct_answer = JSON.stringify(pairs);
            } else if (qType === 'fill_blank') {
                var blanks = parseChallengeOptions(q.correct_answer || '');
                if (!blanks.length) throw new Error('Question ' + (i + 1) + ': add accepted blank answers');
                model.payload = { answers: blanks };
                model.correct_answer = blanks.join(',');
            } else {
                var accepted = parseChallengeOptions(q.correct_answer || '');
                if (!accepted.length) throw new Error('Question ' + (i + 1) + ': add at least one accepted answer');
                model.payload = { accepted_answers: accepted };
                model.correct_answer = accepted.join(',');
            }

            out.push(model);
        }
        return out;
    }

    function getChallengeTypeHelp(type) {
        var t = String(type || 'open');
        if (t === 'multiple_choice') return 'Multiple Choice: put options in "Options" (comma or line). Set one exact correct answer below.';
        if (t === 'multiple_select') return 'Multiple Select: put options in "Options". Put correct options in "Correct answer" separated by comma.';
        if (t === 'true_false') return 'True/False: set "Correct answer" as true or false.';
        if (t === 'matching') return 'Matching: use one pair per line in "Options": Term=Definition.';
        if (t === 'fill_blank') return 'Fill Blank: put accepted blank answers in "Correct answer" separated by comma.';
        return 'Open: put one or more accepted answers in "Correct answer" separated by comma.';
    }

    function extractChallengeTarget(c) {
        if (!c) return null;
        if (c.target_group != null && String(c.target_group).trim() !== '') return String(c.target_group).trim();
        if (c.group_code != null && String(c.group_code).trim() !== '') return String(c.group_code).trim();
        if (Array.isArray(c.target_groups) && c.target_groups.length) return String(c.target_groups[0]).trim();
        if (typeof c.target_groups === 'string' && c.target_groups.trim()) {
            var raw = c.target_groups.trim();
            try {
                var parsed = JSON.parse(raw);
                if (Array.isArray(parsed) && parsed.length) return String(parsed[0]).trim();
            } catch (_) {}
            var first = raw.split(',')[0];
            return first ? String(first).trim() : null;
        }
        return null;
    }

    function escapeHtml(t) { var d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    function escapeAttr(t) {
        return escapeHtml(t).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }
    var DEBUG_MODE = true;
    function showToast(message, type) {
        var container = document.getElementById('toastContainer');
        if (!container || typeof bootstrap === 'undefined') {
            alert(message);
            return;
        }
        var tone = type || 'info';
        var klass = tone === 'danger' ? 'text-bg-danger' : (tone === 'success' ? 'text-bg-success' : 'text-bg-primary');
        var el = document.createElement('div');
        el.className = 'toast align-items-center ' + klass + ' border-0';
        el.setAttribute('role', 'alert');
        el.setAttribute('aria-live', 'assertive');
        el.setAttribute('aria-atomic', 'true');
        el.innerHTML = '<div class="d-flex"><div class="toast-body">' + escapeHtml(String(message || 'Done')) + '</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>';
        container.appendChild(el);
        var delay = tone === 'danger' ? 4500 : 2800;
        var toast = new bootstrap.Toast(el, { delay: delay });
        toast.show();
        el.addEventListener('hidden.bs.toast', function() { el.remove(); });
    }
    function logUiError(tag, err) {
        console.error('[' + tag + ']', err);
        if (DEBUG_MODE && err && err.message) console.debug('[' + tag + '_DETAIL]', err.message);
    }

    var selectedTeacherGroup = '';
    var teacherPocketBalance = 0;
    var giveCoinsModalRef = null;

    function formatNum(n) {
        return Number(n || 0).toLocaleString('en-US');
    }

    function setTeacherPocketDisplay(value) {
        teacherPocketBalance = Math.max(0, Number(value) || 0);
        var wrap = document.getElementById('teacherPocketWrap');
        var el = document.getElementById('teacherPocket');
        if (el) el.textContent = formatNum(teacherPocketBalance);
        if (wrap) wrap.style.display = isTeacherRole ? '' : 'none';
    }

    async function loadTeacherPocket() {
        if (!isTeacherRole) return;
        try {
            // Read coin_budget (hierarchical) first, fallback to coin_pocket, fallback to monedas.
            var res = await supabaseClient
                .from(CONFIG.tables.profiles)
                .select('coin_budget,coin_pocket,monedas')
                .eq('id', user.id)
                .maybeSingle();

            if (res.error) {
                // Some schemas don't have coin_budget/coin_pocket. In that case, read monedas.
                if (isMissingColumnError(res.error, 'coin_budget', CONFIG.tables.profiles) ||
                    isMissingColumnError(res.error, 'coin_pocket', CONFIG.tables.profiles)) {
                    var res2 = await supabaseClient
                        .from(CONFIG.tables.profiles)
                        .select('monedas')
                        .eq('id', user.id)
                        .maybeSingle();
                    if (res2.error) throw res2.error;
                    setTeacherPocketDisplay(Number((res2.data || {}).monedas || 0));
                    return;
                }
                throw res.error;
            }

            var d = res.data || {};
            var balance = d.coin_budget != null ? Number(d.coin_budget)
                : (d.coin_pocket != null ? Number(d.coin_pocket) : Number(d.monedas || 0));
            setTeacherPocketDisplay(balance);
        } catch (e) {
            console.error('[TEACHER_POCKET]', e);
            setTeacherPocketDisplay(0);
        }
    }

    async function loadTeacherWalletHistory() {
        if (!isTeacherRole) return;
        var panel = document.getElementById('teacherWalletPanel');
        var host = document.getElementById('teacherWalletHistory');
        if (!panel || !host) return;

        panel.style.display = '';
        host.className = 'small text-muted mt-2';
        host.textContent = 'Loading...';

        try {
            // Requires MIGRATION_COIN_WALLETS_LEDGER.sql
            if (typeof coinLedgerEnabled !== 'function') {
                host.textContent = 'Ledger helpers not available.';
                return;
            }

            var enabled = await coinLedgerEnabled();
            if (!enabled) {
                host.innerHTML = 'Ledger not installed yet. Run <code>MIGRATION_COIN_WALLETS_LEDGER.sql</code> to see full wallet history.';
                return;
            }

            var widRes = await supabaseClient.rpc('ensure_coin_wallet', { p_owner_type: 'profile', p_owner_id: user.id });
            if (widRes.error || !widRes.data) throw new Error((widRes.error && widRes.error.message) || 'Could not ensure wallet');
            var walletId = String(widRes.data);

            var led = await supabaseClient
                .from('coin_ledger')
                .select('created_at,amount,action,from_wallet_id,to_wallet_id,metadata')
                .or('from_wallet_id.eq.' + walletId + ',to_wallet_id.eq.' + walletId)
                .order('created_at', { ascending: false })
                .limit(25);

            if (led.error) throw led.error;
            var rows = led.data || [];
            if (!rows.length) {
                host.textContent = 'No wallet movements yet.';
                return;
            }

            host.innerHTML = '<div class="admin-table-wrap"><table class="table table-sm mb-0"><thead><tr>' +
                '<th>When</th><th>Type</th><th class="text-end">Amount</th>' +
                '</tr></thead><tbody>' +
                rows.map(function(x) {
                    var when = x.created_at ? new Date(x.created_at).toLocaleString() : '-';
                    var dir = String(x.to_wallet_id || '') === walletId ? 'IN' : 'OUT';
                    var label = dir + ' ¬∑ ' + String(x.action || 'transfer');
                    return '<tr>' +
                        '<td class="small text-muted">' + escapeHtml(when) + '</td>' +
                        '<td>' + escapeHtml(label) + '</td>' +
                        '<td class="text-end">' + Number(x.amount || 0).toLocaleString() + '</td>' +
                    '</tr>';
                }).join('') +
                '</tbody></table></div>';
        } catch (e) {
            console.error('[TEACHER_WALLET_HISTORY]', e);
            host.className = 'small mt-2 text-danger';
            host.textContent = String((e && e.message) || e || 'Could not load wallet history');
        }
    }

    window.refreshTeacherWalletHistory = loadTeacherWalletHistory;

    async function loadTeacherDashboard() {
        var host = document.getElementById('teacherDashboardCards');
        if (!host) return;
        host.innerHTML = '<p class="text-muted small">Loading...</p>';

        try {
            // Ensure pocket is loaded before rendering cards (prevents ‚Äúalways 0‚Äù race).
            await loadTeacherPocket();

            // Prefer strict teacher_groups mapping (more reliable than window._editGroups which depends on load order)
            var groupCodes = [];
            if (isTeacherRole && typeof getTeacherAllowedGroups === 'function') {
                var allowed = await getTeacherAllowedGroups(user.id);
                if (Array.isArray(allowed) && allowed.length) groupCodes = allowed.map(function(x) { return String(x || '').trim(); }).filter(Boolean);
            }
            if (!groupCodes.length) {
                var groups = Array.isArray(window._editGroups) ? window._editGroups : [];
                groupCodes = groups.map(function(g) { return String(g.group_code || '').trim(); }).filter(Boolean);
            }
            if (isTeacherRole && !groupCodes.length) {
                var fallback = String(user.grupo || '').trim();
                if (fallback) groupCodes = [fallback];
            }

            var totalStudents = 0;
            var totalCoins = 0;
            if (groupCodes.length) {
                var stuRes = await supabaseClient
                    .from(CONFIG.tables.profiles)
                    .select('grupo,monedas')
                    .eq('institution_id', user.institution_id)
                    .eq('rol', 'student')
                    .eq('is_active', true)
                    .in('grupo', groupCodes);
                if (!stuRes.error) {
                    (stuRes.data || []).forEach(function(r) {
                        totalStudents += 1;
                        totalCoins += (Number(r.monedas) || 0);
                    });
                }
            }

            function card(icon, label, value, colorClass) {
                return '<div class="col-6 col-md-3"><div class="glass-panel text-center" style="padding:1rem;">' +
                    '<div style="font-size:1.8rem;">' + icon + '</div>' +
                    '<div class="fw-bold fs-4 ' + colorClass + '">' + value + '</div>' +
                    '<div class="small text-muted">' + label + '</div>' +
                '</div></div>';
            }

            host.innerHTML =
                card('üè´', 'Your groups', groupCodes.length, 'text-success') +
                card('üë©‚Äçüéì', 'Students', totalStudents, 'text-primary') +
                card('ü™ô', 'Coins in circulation', totalCoins.toLocaleString(), 'text-warning') +
                card('üéí', 'Your budget', teacherPocketBalance.toLocaleString(), 'text-info');
        } catch (e) {
            console.error('[TEACHER_DASHBOARD]', e);
            host.innerHTML = '<div class="alert alert-danger">Error loading dashboard.</div>';
        }
    }

    function renderTeacherGroupTabs(groupCodes) {
        var tabs = document.getElementById('teacherGroupTabs');
        var select = document.getElementById('adminGroupFilter');
        if (!tabs || !select || !isTeacherRole) return;
        var codes = Array.isArray(groupCodes) ? groupCodes.slice() : [];
        if (!codes.length) {
            tabs.style.display = '';
            tabs.innerHTML = '<span class="small text-muted">No groups assigned to your account</span>';
            return;
        }
        if (!selectedTeacherGroup || codes.indexOf(selectedTeacherGroup) === -1) {
            selectedTeacherGroup = codes[0];
        }
        tabs.style.display = '';
        tabs.innerHTML = codes.map(function(code) {
            var active = code === selectedTeacherGroup;
            return '<button type="button" class="btn btn-sm ' + (active ? 'btn-warning' : 'btn-outline-warning') + '" data-group-tab="' + escapeAttr(code) + '">' + escapeHtml(code) + '</button>';
        }).join('');
        tabs.querySelectorAll('[data-group-tab]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                selectedTeacherGroup = btn.getAttribute('data-group-tab') || '';
                select.value = selectedTeacherGroup;
                renderTeacherGroupTabs(codes);
                window.refreshStudents();
            });
        });
    }

    async function getTeacherGroupCodes() {
        if (!isTeacherRole) return null;
        // Prefer teacher_groups table via app.js helper when available.
        try {
            if (typeof getTeacherAllowedGroups === 'function') {
                var codes = await getTeacherAllowedGroups(user.id);
                if (Array.isArray(codes) && codes.length) return codes;
            }
        } catch (_) {}
        var ownGroup = String(user.grupo || '').trim();
        return ownGroup ? [ownGroup] : [];
    }

    window.refreshStudents = async function() {
        var group = getSelectedGroup();
        if (isTeacherRole) {
            // Teachers can have multiple groups via teacher_groups; use currently selected tab.
            group = String(selectedTeacherGroup || '').trim() || String(user.grupo || '').trim();
        }
        var q = (document.getElementById('studentSearch').value || '').trim();
        console.log('[ADMIN] Refreshing students for group:', group);
        var content = document.getElementById('contentUsers');
        content.innerHTML = '<p class="text-center">Loading...</p>';

        try {
            if (isTeacherRole && !group) {
                content.innerHTML = '<div class="empty-state">No group assigned to your account.</div>';
                return;
            }

            var query = supabaseClient
                .from(CONFIG.tables.profiles)
                .select('id,nombre_completo,documento_id,pin,grupo,monedas,rol,institution_id')
                .eq('rol', 'student')
                .eq('institution_id', user.institution_id)
                .order('nombre_completo');
            if (group) query = query.eq('grupo', group);
            var rs = await query;
            if (rs.error) throw rs.error;
            var list = rs.data || [];
            if (q) {
                var ql = String(q).toLowerCase();
                list = list.filter(function(s) {
                    var nm = String(s.nombre_completo || '').toLowerCase();
                    var doc = String(s.documento_id || '').toLowerCase();
                    return nm.includes(ql) || doc.includes(ql);
                });
            }
            if (isTeacherRole) {
                list = (list || []).filter(function(s) {
                    return String(s.rol || '') === 'student' && String(s.grupo || '') === group;
                });
            }

            if (isTeacherRole) {
                await loadTeacherAbsenceAlerts(group, true);
            }

            var teacherStatsByDoc = {};
            if (isTeacherRole && list && list.length) {
                var docs = list.map(function(s) { return String(s.documento_id || '').trim(); }).filter(Boolean);
                if (docs.length) {
                    try {
                        var ccRes = await supabaseClient
                            .from(CONFIG.tables.completed_challenges)
                            .select('student_id')
                            .in('student_id', docs);
                        if (!ccRes.error) {
                            (ccRes.data || []).forEach(function(r) {
                                var k = String(r.student_id || '');
                                if (!teacherStatsByDoc[k]) teacherStatsByDoc[k] = { completed: 0, lastAttendance: '-' };
                                teacherStatsByDoc[k].completed += 1;
                            });
                        }
                    } catch (_) {}

                    try {
                        var atRes = await supabaseClient
                            .from(CONFIG.tables.attendance)
                            .select('student_id,attendance_date')
                            .eq('group_code', group)
                            .in('student_id', docs)
                            .order('attendance_date', { ascending: false });
                        if (!atRes.error) {
                            (atRes.data || []).forEach(function(r) {
                                var k = String(r.student_id || '');
                                if (!teacherStatsByDoc[k]) teacherStatsByDoc[k] = { completed: 0, lastAttendance: '-' };
                                if (teacherStatsByDoc[k].lastAttendance === '-' && r.attendance_date) {
                                    teacherStatsByDoc[k].lastAttendance = String(r.attendance_date);
                                }
                            });
                        }
                    } catch (_) {}
                }
            }

            console.log('[ADMIN] Students loaded:', list ? list.length : 0);
            if (!list || !list.length) {
                content.innerHTML = '<div class="empty-state">No students match your filter.</div>';
                return;
            }
            var bulkHead = isTeacherRole ? '' : '<th><input type="checkbox" id="selectAllStudents" onclick="toggleSelectAllStudents(this)"></th>';
            var html = '<div class="admin-table-wrap"><table class="student-table"><thead><tr>' + bulkHead +
                (isTeacherRole
                    ? '<th>Student name</th><th>Coins</th><th>Completed challenges</th><th>Last attendance</th><th>Actions</th>'
                    : '<th>Name</th><th>Document</th><th>Role</th><th>Group</th><th>Coins</th><th>Actions</th>') +
                '</tr></thead><tbody>';
            list.forEach(function(s) {
                var coins = s.monedas != null ? s.monedas : 0;
                var sid = String(s.id || '').replace(/'/g, "\\'");
                var sname = String(s.nombre_completo || '').replace(/'/g, "\\'");
                var sdoc = String(s.documento_id || '').replace(/'/g, "\\'");
                var spin = String(s.pin || '').replace(/'/g, "\\'");
                var sgroup = String(s.grupo || '').replace(/'/g, "\\'");
                var srol = String(s.rol || '').replace(/'/g, "\\'");
                var isProtected = s.rol === 'super_admin';
                var actionButtons = '';
                if (!isTeacherRole) {
                    actionButtons = '<button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="window.openEdit(\'' + sid + '\',\'' + sname + '\',\'' + sdoc + '\',\'' + spin + '\',\'' + sgroup + '\',\'' + srol + '\')">Edit</button>';
                }
                if (s.rol === 'student') {
                    actionButtons += '<button type="button" class="btn btn-sm btn-outline-warning me-1" onclick="window.openImprovementModal(\'' + sid + '\',\'' + sname + '\')" title="Asignar Plan de Mejora">üéØ Plan</button>';
                    if (isTeacherRole) {
                        actionButtons += '<button type="button" class="btn btn-sm btn-outline-success me-1" onclick="window.openGiveCoins(\'' + sid + '\',\'' + sname + '\')">Give ü™ô</button>';
                    }
                }
                if (!isTeacherRole && !isProtected) {
                    actionButtons += '<button type="button" class="btn btn-sm btn-outline-danger" onclick="window.deleteStudentRow(\'' + sid + '\',\'' + srol + '\')">Delete</button>';
                }
                if (!actionButtons) actionButtons = '<span class="small text-muted">View</span>';
                var tStats = teacherStatsByDoc[String(s.documento_id || '')] || { completed: 0, lastAttendance: '-' };
                var absences = Number(((window._teacherAbsenceMap || {})[String(s.documento_id || '')] || 0));
                var absenceBadge = absences >= 3 ? '<span class="absence-badge">‚ö†Ô∏è 3+ absences</span>' : '';
                if (isTeacherRole) {
                    html += '<tr data-id="' + s.id + '" data-group="' + escapeAttr(s.grupo || '') + '">' +
                        '<td class="cell-ellipsis" title="' + escapeAttr(s.nombre_completo || '') + '"><strong>' + escapeHtml(s.nombre_completo || '') + '</strong>' + absenceBadge + '</td>' +
                        '<td class="coin-cell"><span class="coin-display" id="coins-' + s.id + '">' + coins + '</span></td>' +
                        '<td>' + Number(tStats.completed || 0) + '</td>' +
                        '<td>' + escapeHtml(tStats.lastAttendance || '-') + '</td>' +
                        '<td>' + actionButtons + '</td>' +
                        '</tr>';
                    return;
                }
                html += '<tr data-id="' + s.id + '">' +
                    (isTeacherRole ? '' : '<td><input type="checkbox" class="student-row-check" value="' + escapeAttr(s.id || '') + '"></td>') +
                    '<td class="cell-ellipsis" title="' + escapeAttr(s.nombre_completo || '') + '"><strong>' + escapeHtml(s.nombre_completo || '') + '</strong></td>' +
                    '<td class="cell-ellipsis" title="' + escapeAttr(s.documento_id || '') + '">' + escapeHtml(s.documento_id || '') + '</td>' +
                    '<td><span class="badge-role">' + escapeHtml(s.rol || '-') + '</span></td>' +
                    '<td class="cell-ellipsis" title="' + escapeAttr(s.grupo || '-') + '"><span class="badge-group">' + escapeHtml(s.grupo || '-') + '</span></td>' +
                    '<td class="coin-cell">' +
                    '<span class="coin-display" id="coins-' + s.id + '">' + coins + '</span>' +
                    (!isTeacherRole ? ('<button type="button" class="btn btn-success btn-coin" onclick="window.addCoins(\'' + s.id + '\', 10)">+10</button>' +
                    '<button type="button" class="btn btn-danger btn-coin" onclick="window.addCoins(\'' + s.id + '\', -10)">-10</button>') : '') +
                    '</td><td>' +
                    actionButtons +
                    '</td></tr>';
            });
            html += '</tbody></table></div>' +
                (isTeacherRole ? '' : ('<div class="mt-2 d-flex gap-2 align-items-center" id="bulkActionBar" style="display:none!important;">' +
                '<span id="bulkSelectedCount" class="small text-muted">0 selected</span>' +
                '<button type="button" class="btn btn-sm btn-danger" onclick="bulkRemoveStudentsFromGroup()">Remove Selected from Group</button>' +
                '</div>'));
            content.innerHTML = html;
        } catch (e) {
            logUiError('USERS_LOAD_ERROR', e);
            content.innerHTML = '<div class="alert alert-danger">Error loading students: ' + (e.message || 'Unknown error') + '<br><small>Check console for details</small></div>';
        }
    };

    window.deleteAuctionAdmin = function(auctionId, status) {
        var safeStatus = String(status || '').toLowerCase();
        if (safeStatus === 'active') {
            showToast('Active auctions cannot be deleted. Close it first.', 'danger');
            return;
        }
        if (!confirm('Delete this closed/finished auction? This cannot be undone.')) return;
        deleteAuction(auctionId).then(function(result) {
            if (!result.ok) {
                showToast('Error deleting auction: ' + (result.error || 'Unknown'), 'danger');
                return;
            }
            showToast('Auction deleted', 'success');
            window.loadAuctionList();
        }).catch(function(e) {
            logUiError('AUCTION_DELETE_ERROR', e);
            showToast('Failed to delete auction', 'danger');
        });
    };

    document.getElementById('adminGroupFilter').addEventListener('change', function() {
        if (isTeacherRole) {
            selectedTeacherGroup = String(user.grupo || '').trim();
            document.getElementById('adminGroupFilter').value = selectedTeacherGroup;
            renderTeacherGroupTabs((window._editGroups || []).map(function(g) { return String(g.group_code || ''); }).filter(Boolean));
        }
        window.refreshStudents();
    });
    document.getElementById('btnRefreshUsers').addEventListener('click', window.refreshStudents);
    document.getElementById('studentSearch').addEventListener('input', window.refreshStudents);

    function updateBulkBar() {
        var checks = Array.prototype.slice.call(document.querySelectorAll('.student-row-check'));
        var selected = checks.filter(function(cb) { return cb.checked; });
        var bar = document.getElementById('bulkActionBar');
        var countEl = document.getElementById('bulkSelectedCount');
        if (countEl) countEl.textContent = selected.length + ' selected';
        if (bar) bar.style.display = selected.length ? '' : 'none';
        var master = document.getElementById('selectAllStudents');
        if (master) {
            master.checked = !!checks.length && selected.length === checks.length;
            master.indeterminate = selected.length > 0 && selected.length < checks.length;
        }
    }

    window.toggleSelectAllStudents = function(masterCb) {
        var checked = !!(masterCb && masterCb.checked);
        document.querySelectorAll('.student-row-check').forEach(function(cb) {
            cb.checked = checked;
        });
        updateBulkBar();
    };

    document.addEventListener('change', function(e) {
        if (e && e.target && e.target.classList && e.target.classList.contains('student-row-check')) {
            updateBulkBar();
        }
    });

    var bulkRemoveBusy = false;
    window.bulkRemoveStudentsFromGroup = function() {
        if (bulkRemoveBusy) return;
        var selectedIds = Array.prototype.slice.call(document.querySelectorAll('.student-row-check:checked')).map(function(cb) {
            return cb.value;
        }).filter(Boolean);
        if (!selectedIds.length) {
            showToast('Select at least one student', 'danger');
            return;
        }
        if (!confirm('Remove selected students from their group?')) return;
        bulkRemoveBusy = true;
        Promise.all(selectedIds.map(function(id) {
            return updateProfile(id, { grupo: null });
        })).then(function() {
            showToast('Selected students removed from group', 'success');
            window.refreshStudents();
        }).catch(function(e) {
            logUiError('BULK_REMOVE_GROUP_ERROR', e);
            showToast('Failed to remove selected students: ' + (e.message || 'Unknown'), 'danger');
        }).finally(function() {
            bulkRemoveBusy = false;
        });
    };

    window.addCoins = function(studentId, delta) {
        addStudentCoins(studentId, delta).then(function(result) {
            if (result.ok && result.newCoins !== undefined) {
                var el = document.getElementById('coins-' + studentId);
                if (el) el.textContent = result.newCoins;
                showToast('Coins updated', 'success');
            } else showToast('Error: ' + (result.error || 'Try again.'), 'danger');
        }).catch(function(e) {
            logUiError('COINS_UPDATE_ERROR', e);
            showToast('Failed to update coins', 'danger');
        });
    };

    window.openGiveCoins = function(studentId, studentName) {
        var sid = String(studentId || '').trim();
        if (!sid) return;
        document.getElementById('giveCoinsStudentId').value = sid;
        document.getElementById('giveCoinsStudentName').value = studentName || '';
        document.getElementById('giveCoinsAmount').value = '';
        document.getElementById('giveCoinsReason').value = '';
        document.getElementById('giveCoinsStatus').textContent = '';
        if (!giveCoinsModalRef) giveCoinsModalRef = new bootstrap.Modal(document.getElementById('giveCoinsModal'));
        giveCoinsModalRef.show();
    };

    document.getElementById('btnConfirmGiveCoins').addEventListener('click', async function() {
        var btn = this;
        var studentId = String(document.getElementById('giveCoinsStudentId').value || '').trim();
        var amount = Math.floor(Number(document.getElementById('giveCoinsAmount').value) || 0);
        var reason = String(document.getElementById('giveCoinsReason').value || '').trim();
        var statusEl = document.getElementById('giveCoinsStatus');
        if (!studentId) return;
        if (amount <= 0) {
            statusEl.className = 'small mt-2 text-danger';
            statusEl.textContent = 'Enter a valid amount.';
            return;
        }
        if (!reason) {
            statusEl.className = 'small mt-2 text-danger';
            statusEl.textContent = 'Reason is required.';
            return;
        }
        if (teacherPocketBalance < amount) {
            showToast('Insufficient coins in your budget (' + teacherPocketBalance + ' available)', 'danger');
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Giving...';
        statusEl.className = 'small mt-2 text-info';
        statusEl.textContent = 'Processing...';

        try {
            // Verify student is in teacher's institution
            var stuRes = await supabaseClient
                .from(CONFIG.tables.profiles)
                .select('id,monedas,institution_id,grupo')
                .eq('id', studentId)
                .maybeSingle();
            if (stuRes.error || !stuRes.data) throw new Error(stuRes.error ? stuRes.error.message : 'Student not found');
            if (String(stuRes.data.institution_id || '') !== String(user.institution_id || '')) {
                throw new Error('Student is outside your institution');
            }
            // Teacher can only award to students in assigned group(s)
            var allowedGroups = (Array.isArray(window._editGroups) ? window._editGroups : [])
                .map(function(g) { return String(g.group_code || '').trim(); })
                .filter(Boolean);
            if (!allowedGroups.length) {
                var fallbackGroup = String(user.grupo || '').trim();
                if (fallbackGroup) allowedGroups = [fallbackGroup];
            }
            var studentGroup = String(stuRes.data.grupo || '').trim();
            if (allowedGroups.length && studentGroup && allowedGroups.indexOf(studentGroup) === -1) {
                throw new Error('Student is not in your assigned groups');
            }

            // Use hierarchical budget function if available (enforces coin_budget ceiling)
            if (typeof teacherAwardCoinsToStudent === 'function') {
                var r = await teacherAwardCoinsToStudent(user.id, studentId, amount);
                if (!r.ok) throw new Error(r.error || 'Could not award coins');
                setTeacherPocketDisplay(Math.max(0, teacherPocketBalance - amount));
                var coinEl2 = document.getElementById('coins-' + studentId);
                if (coinEl2) coinEl2.textContent = String(r.newStudentCoins);
                showToast('Coins granted successfully', 'success');
                if (giveCoinsModalRef) giveCoinsModalRef.hide();
                await loadTeacherPocket();
                return;
            }

            // Fallback: direct update (deduct teacher first, then credit student)
            var currentPocket = teacherPocketBalance;
            var nextPocket = Math.max(0, currentPocket - amount);

            // 1) Deduct from teacher pocket
            var updPocket = await supabaseClient
                .from(CONFIG.tables.profiles)
                .update({ coin_budget: nextPocket })
                .eq('id', user.id);
            if (updPocket.error && typeof isMissingColumnError === 'function' && isMissingColumnError(updPocket.error, 'coin_budget', CONFIG.tables.profiles)) {
                updPocket = await supabaseClient
                    .from(CONFIG.tables.profiles)
                    .update({ coin_pocket: nextPocket })
                    .eq('id', user.id);
            }
            if (updPocket.error && typeof isMissingColumnError === 'function' && isMissingColumnError(updPocket.error, 'coin_pocket', CONFIG.tables.profiles)) {
                updPocket = await supabaseClient
                    .from(CONFIG.tables.profiles)
                    .update({ monedas: nextPocket })
                    .eq('id', user.id);
            }
            if (updPocket.error) throw updPocket.error;

            // 2) Credit student
            var currentStudentCoins = Number(stuRes.data.monedas) || 0;
            var nextStudentCoins = currentStudentCoins + amount;
            var updStudent = await supabaseClient
                .from(CONFIG.tables.profiles)
                .update({ monedas: nextStudentCoins })
                .eq('id', studentId);
            if (updStudent.error) {
                // Rollback teacher (best-effort)
                try {
                    var rb = await supabaseClient.from(CONFIG.tables.profiles).update({ coin_budget: currentPocket }).eq('id', user.id);
                    if (rb.error && typeof isMissingColumnError === 'function' && isMissingColumnError(rb.error, 'coin_budget', CONFIG.tables.profiles)) {
                        rb = await supabaseClient.from(CONFIG.tables.profiles).update({ coin_pocket: currentPocket }).eq('id', user.id);
                    }
                    if (rb.error && typeof isMissingColumnError === 'function' && isMissingColumnError(rb.error, 'coin_pocket', CONFIG.tables.profiles)) {
                        await supabaseClient.from(CONFIG.tables.profiles).update({ monedas: currentPocket }).eq('id', user.id);
                    }
                } catch (_) {}
                throw updStudent.error;
            }

            try {
                if (typeof insertStudentCoinTransaction === 'function') {
                    insertStudentCoinTransaction(studentId, amount, reason || 'teacher_grant', nextStudentCoins);
                } else {
                    await supabaseClient
                        .from(CONFIG.tables.student_coin_transactions)
                        .insert([{
                            student_id: studentId,
                            amount: amount,
                            reason: reason || 'teacher_grant',
                            balance_after: nextStudentCoins,
                            created_at: new Date().toISOString()
                        }]);
                }
            } catch (_) {}

            setTeacherPocketDisplay(nextPocket);
            var coinEl = document.getElementById('coins-' + studentId);
            if (coinEl) coinEl.textContent = String(nextStudentCoins);
            showToast('Coins granted successfully', 'success');
            if (giveCoinsModalRef) giveCoinsModalRef.hide();
        } catch (e) {
            console.error('[GIVE_COINS]', e);
            showToast(e.message || 'Could not give coins', 'danger');
            statusEl.className = 'small mt-2 text-danger';
            statusEl.textContent = e.message || 'Could not give coins';
            await loadTeacherPocket();
        } finally {
            btn.disabled = false;
            btn.textContent = 'Give Coins';
        }
    });

    var editModalEl;
    var groupEditModalEl;
    window.openEdit = function(profileId, name, doc, pin, group, role) {
        document.getElementById('editProfileId').value = profileId;
        document.getElementById('editName').value = name || '';
        document.getElementById('editDoc').value = doc || '';
        document.getElementById('editPin').value = '';
        document.getElementById('editPin').placeholder = 'Leave blank to keep current';
        var roleWrap = document.getElementById('editRoleWrap');
        var roleSel = document.getElementById('editRole');
        var currentRole = role || 'student';
        roleSel.value = (currentRole === 'admin') ? 'admin' : 'student';
        roleWrap.style.display = currentRole === 'super_admin' ? 'none' : '';
        var sel = document.getElementById('editGroup');
        sel.innerHTML = '';
        (window._editGroups || []).forEach(function(g) {
            var opt = document.createElement('option');
            opt.value = g.group_code;
            opt.textContent = g.group_code;
            if (g.group_code === group) opt.selected = true;
            sel.appendChild(opt);
        });
        if (!editModalEl) editModalEl = new bootstrap.Modal(document.getElementById('editModal'));
        editModalEl.show();
    };

    window.saveEdit = function() {
        var id = document.getElementById('editProfileId').value;
        var name = document.getElementById('editName').value.trim();
        var doc = document.getElementById('editDoc').value.trim();
        var pin = document.getElementById('editPin').value;
        var roleWrap = document.getElementById('editRoleWrap');
        var role = document.getElementById('editRole').value;
        var group = document.getElementById('editGroup').value;
        if (!name || !doc) { showToast('Name and document are required', 'danger'); return; }
        var fields = { nombre_completo: name, documento_id: doc, grupo: group };
        if (pin !== '') fields.pin = pin;
        if (roleWrap.style.display !== 'none') fields.rol = role;
        updateProfile(id, fields).then(function() {
            editModalEl.hide();
            window.refreshStudents();
            showToast('User updated successfully', 'success');
        }).catch(function(e) {
            logUiError('USER_EDIT_ERROR', e);
            showToast('Error saving user: ' + (e.message || 'Try again.'), 'danger');
        });
    };
    document.getElementById('btnSaveEdit').addEventListener('click', window.saveEdit);

    window.deleteStudentRow = function(profileId, role) {
        if (role === 'super_admin') {
            showToast('super_admin cannot be deleted from UI', 'danger');
            return;
        }
        if (!confirm('Delete this student? This cannot be undone.')) return;
        deleteStudent(profileId).then(function() {
            showToast('User deleted', 'success');
            window.refreshStudents();
        }).catch(function(e) {
            logUiError('USER_DELETE_ERROR', e);
            showToast('Error deleting user: ' + (e.message || 'Maybe they have related records.'), 'danger');
        });
    };

    document.getElementById('btnCreateGroup').addEventListener('click', function() {
        var input = document.getElementById('newGroupCode');
        var code = input.value.trim();
        if (!code) { showToast('Enter a group code.', 'danger'); return; }
        insertGroup(code).then(function() {
            input.value = '';
            window._editGroups.push({ group_code: code });
            var sel = document.getElementById('adminGroupFilter');
            var qrSel = document.getElementById('qrGroup');
            var aucSel = document.getElementById('auctionGroup');
            var annSel = document.getElementById('announcementGroup');
            [sel, qrSel, aucSel, annSel].forEach(function(s) {
                if (!s) return;
                var opt = document.createElement('option');
                opt.value = code;
                opt.textContent = code;
                s.appendChild(opt);
            });
            showToast('Group created', 'success');
            window.loadGroupsList();
        }).catch(function(e) {
            logUiError('GROUP_CREATE_ERROR', e);
            showToast('Error creating group: ' + (e.message || 'Try again.'), 'danger');
        });
    });

    // --- Attendance: group required for QR; today's list ---
    window.generateQR = function() {
        var g = getSelectedQRGroup();
        if (!g) { document.getElementById('qrError').style.display = 'block'; document.getElementById('qrError').textContent = 'Select a group first.'; return; }
        var btn = document.getElementById('btnGenerateQR');
        btn.disabled = true;
        btn.textContent = 'Creating session...';
        document.getElementById('qrError').style.display = 'none';
        document.getElementById('qrcode').innerHTML = '';
        function finishSession(lat, lng, geoStatus) {
            var startTime = new Date().toISOString();
            createAttendanceSession(g, {
                adminLat: lat,
                adminLng: lng,
                createdBy: user.documento_id || user.id,
                durationMinutes: 30,
                qrPayload: { g: g, startTime: startTime, geoStatus: geoStatus || 'unknown' }
            }).then(function(sessionRes) {
                if (!sessionRes.ok || !sessionRes.session) throw new Error(sessionRes.error || 'Could not create attendance session');
                var manualCode = String(sessionRes.session.session_code || '').toUpperCase();
                var baseUrl = window.location.origin;
                var url = baseUrl + '/attendance.html?session=' + encodeURIComponent(manualCode);
                var container = document.getElementById('qrcode');
                container.innerHTML = '';
                if (typeof QRCode !== 'undefined') {
                    new QRCode(container, { text: url, width: 256, height: 256 });
                } else {
                    container.innerHTML = '<p class="text-danger">QRCode library not loaded. Check script.</p>';
                }
                var manualWrap = document.getElementById('manualAttendanceCodeWrap');
                var manualInput = document.getElementById('manualAttendanceCode');
                if (manualWrap && manualInput) {
                    manualInput.value = manualCode;
                    manualWrap.style.display = '';
                }
                btn.disabled = false;
                btn.textContent = 'Generate Attendance Session (QR + code)';
                window.refreshAttendanceList();
            }).catch(function(e) {
                document.getElementById('qrError').textContent = 'Could not create attendance session: ' + (e.message || 'Unknown');
                document.getElementById('qrError').style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Generate Attendance Session (QR + code)';
            });
        }
        if (!navigator.geolocation) {
            finishSession(null, null, 'no_geolocation');
            return;
        }
        navigator.geolocation.getCurrentPosition(function(pos) {
            finishSession(pos.coords.latitude, pos.coords.longitude, 'ok');
        }, function() {
            finishSession(null, null, 'gps_failed');
        }, { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 });
    };
    document.getElementById('btnGenerateQR').addEventListener('click', window.generateQR);
    document.getElementById('btnCopyAttendanceCode').addEventListener('click', function() {
        var input = document.getElementById('manualAttendanceCode');
        if (!input || !input.value) {
            showToast('Generate a QR first to create a manual code', 'danger');
            return;
        }
        try {
            input.select();
            input.setSelectionRange(0, 99999);
            document.execCommand('copy');
            showToast('Manual code copied', 'success');
        } catch (e) {
            logUiError('ATTENDANCE_CODE_COPY_ERROR', e);
            showToast('Could not copy. Please copy manually.', 'danger');
        }
    });

    function formatDateISO(isoLike) {
        var d = isoLike ? new Date(isoLike) : null;
        if (!d || isNaN(d.getTime())) return '-';
        return d.toLocaleDateString();
    }

    async function loadTeacherAbsenceAlerts(groupCode, silentToast) {
        if (!isTeacherRole || !groupCode) return;
        try {
            var cutoffIso = new Date(Date.now() - (30 * 24 * 60 * 60 * 1000)).toISOString();
            var cutoffDate = cutoffIso.slice(0, 10);

            var stuRes = await supabaseClient
                .from(CONFIG.tables.profiles)
                .select('documento_id,nombre_completo')
                .eq('institution_id', user.institution_id)
                .eq('rol', 'student')
                .eq('grupo', groupCode)
                .order('nombre_completo', { ascending: true });
            if (stuRes.error) throw stuRes.error;
            var students = stuRes.data || [];
            var nextMap = {};
            students.forEach(function(s) { nextMap[String(s.documento_id || '')] = 0; });

            var sesRes = await supabaseClient
                .from(CONFIG.tables.attendance_sessions)
                .select('created_at')
                .eq('group_code', groupCode)
                .gte('created_at', cutoffIso)
                .order('created_at', { ascending: false });
            if (sesRes.error && isMissingColumnError(sesRes.error, 'group_code', CONFIG.tables.attendance_sessions)) {
                window._teacherAbsenceMap = nextMap;
                return;
            }
            if (sesRes.error) throw sesRes.error;

            var sessionDatesSet = {};
            (sesRes.data || []).forEach(function(r) {
                var d = String(r.created_at || '').slice(0, 10);
                if (d) sessionDatesSet[d] = true;
            });
            var sessionDates = Object.keys(sessionDatesSet);
            var totalSessions = sessionDates.length;

            if (!totalSessions || !students.length) {
                window._teacherAbsenceMap = nextMap;
                return;
            }

            var docs = students.map(function(s) { return String(s.documento_id || '').trim(); }).filter(Boolean);
            var attRes = await supabaseClient
                .from(CONFIG.tables.attendance)
                .select('student_id,attendance_date')
                .eq('group_code', groupCode)
                .gte('attendance_date', cutoffDate)
                .in('student_id', docs);
            if (attRes.error) throw attRes.error;

            var attendedByStudent = {};
            (attRes.data || []).forEach(function(a) {
                var sid = String(a.student_id || '');
                var day = String(a.attendance_date || '');
                if (!sessionDatesSet[day]) return;
                if (!attendedByStudent[sid]) attendedByStudent[sid] = {};
                attendedByStudent[sid][day] = true;
            });

            var alerted = window._teacherAbsenceNotified || {};
            students.forEach(function(s) {
                var sid = String(s.documento_id || '');
                var attendedCount = attendedByStudent[sid] ? Object.keys(attendedByStudent[sid]).length : 0;
                var absences = Math.max(0, totalSessions - attendedCount);
                nextMap[sid] = absences;
                if (!silentToast && absences >= 3 && !alerted[sid]) {
                    alerted[sid] = true;
                    showToast('‚ö†Ô∏è ' + (s.nombre_completo || 'Student') + ' has missed 3+ classes', 'danger');
                }
            });
            window._teacherAbsenceNotified = alerted;
            window._teacherAbsenceMap = nextMap;
        } catch (e) {
            console.error('[ABSENCE_ALERTS]', e);
        }
    }

    async function loadAttendanceSessionSummary(groupCode) {
        var el = document.getElementById('attendanceSessionSummary');
        if (!el) return;
        if (!groupCode) {
            el.innerHTML = '<p class="text-muted small">Select a group to see attended vs absent by session.</p>';
            return;
        }

        try {
            var cutoffIso = new Date(Date.now() - (30 * 24 * 60 * 60 * 1000)).toISOString();
            var cutoffDate = cutoffIso.slice(0, 10);
            var stuRes = await supabaseClient
                .from(CONFIG.tables.profiles)
                .select('documento_id,nombre_completo')
                .eq('institution_id', user.institution_id)
                .eq('rol', 'student')
                .eq('grupo', groupCode)
                .order('nombre_completo', { ascending: true });
            if (stuRes.error) throw stuRes.error;
            var students = stuRes.data || [];
            if (!students.length) {
                el.innerHTML = '<p class="text-muted small">No students in this group.</p>';
                return;
            }

            var sessionsRes = await supabaseClient
                .from(CONFIG.tables.attendance_sessions)
                .select('created_at,session_code')
                .eq('group_code', groupCode)
                .gte('created_at', cutoffIso)
                .order('created_at', { ascending: false })
                .limit(30);
            if (sessionsRes.error && isMissingColumnError(sessionsRes.error, 'group_code', CONFIG.tables.attendance_sessions)) {
                el.innerHTML = '<p class="text-muted small">Session table unavailable in this schema.</p>';
                return;
            }
            if (sessionsRes.error) throw sessionsRes.error;
            var sessions = sessionsRes.data || [];
            if (!sessions.length) {
                el.innerHTML = '<p class="text-muted small">No sessions in the last 30 days.</p>';
                return;
            }

            var docs = students.map(function(s) { return String(s.documento_id || '').trim(); }).filter(Boolean);
            var attRes = await supabaseClient
                .from(CONFIG.tables.attendance)
                .select('student_id,attendance_date')
                .eq('group_code', groupCode)
                .gte('attendance_date', cutoffDate)
                .in('student_id', docs);
            if (attRes.error) throw attRes.error;

            var namesByDoc = {};
            students.forEach(function(s) { namesByDoc[String(s.documento_id || '')] = String(s.nombre_completo || ''); });
            var attendedByDay = {};
            (attRes.data || []).forEach(function(r) {
                var day = String(r.attendance_date || '');
                if (!attendedByDay[day]) attendedByDay[day] = {};
                attendedByDay[day][String(r.student_id || '')] = true;
            });

            var html = sessions.map(function(ses) {
                var day = String(ses.created_at || '').slice(0, 10);
                var attendedSet = attendedByDay[day] || {};
                var attended = students.filter(function(s) { return !!attendedSet[String(s.documento_id || '')]; });
                var absent = students.filter(function(s) { return !attendedSet[String(s.documento_id || '')]; });
                return '<div class="session-breakdown">' +
                    '<div class="small text-warning mb-1"><strong>Date:</strong> ' + escapeHtml(formatDateISO(ses.created_at)) + ' ¬∑ <strong>Session:</strong> ' + escapeHtml(String(ses.session_code || '-')) + '</div>' +
                    '<div class="small"><strong>Attended (' + attended.length + '):</strong> ' + escapeHtml(attended.map(function(a) { return namesByDoc[String(a.documento_id || '')] || a.documento_id; }).join(', ') || '‚Äî') + '</div>' +
                    '<div class="small text-danger mt-1"><strong>Absent (' + absent.length + '):</strong> ' + escapeHtml(absent.map(function(a) { return namesByDoc[String(a.documento_id || '')] || a.documento_id; }).join(', ') || '‚Äî') + '</div>' +
                    '</div>';
            }).join('');
            el.innerHTML = html;
        } catch (e) {
            console.error('[ATTENDANCE_SESSION_SUMMARY]', e);
            el.innerHTML = '<div class="alert alert-danger">Error loading session attendance summary.</div>';
        }
    }

    window.refreshAttendanceList = async function() {
        var g = getSelectedQRGroup();
        var el = document.getElementById('attendanceTodayList');
        if (!g) {
            el.innerHTML = '<p class="text-muted small">Select a group to see who checked in today.</p>';
            await loadAttendanceSessionSummary('');
            return;
        }
        var list = await getTodayAttendanceByGroup(g);
        if (!list.length) el.innerHTML = '<p class="text-muted small">No check-ins today for this group.</p>';
        else el.innerHTML = '<ul class="list-group">' + list.map(function(r) {
            var time = r.created_at ? new Date(r.created_at).toLocaleTimeString() : '';
            return '<li class="list-group-item d-flex justify-content-between"><span>' + escapeHtml(r.nombre_completo) + '</span><span class="text-muted small">' + time + '</span></li>';
        }).join('') + '</ul>';
        await loadAttendanceSessionSummary(g);
        if (isTeacherRole) {
            await loadTeacherAbsenceAlerts(g, true);
        }
    };
    document.getElementById('qrGroup').addEventListener('change', window.refreshAttendanceList);

    document.getElementById('btnExportCSV').addEventListener('click', function() {
        getTodayAttendanceForReport().then(function(rows) {
            if (!rows.length) { showToast('No attendance recorded today.', 'danger'); return; }
            var csv = 'Name,Group,Date,Time\n';
            rows.forEach(function(r) {
                var time = r.created_at ? new Date(r.created_at).toLocaleTimeString() : '';
                csv += '"' + (r.nombre_completo || '').replace(/"/g, '""') + '","' + (r.group_code || '') + '","' + (r.attendance_date || '') + '","' + time + '"\n';
            });
            var blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'attendance_' + new Date().toISOString().slice(0, 10) + '.csv';
            a.click();
            URL.revokeObjectURL(a.href);
        });
    });

    // --- Store: create auctions with group + duration ---
    var createAuctionBusy = false;
    window.createAuctionItem = function() {
        if (createAuctionBusy) return;
        var name = document.getElementById('auctionItemName').value.trim();
        var desc = document.getElementById('auctionDescription').value.trim();
        var price = parseInt(document.getElementById('auctionBasePrice').value, 10) || 0;
        var groupCode = document.getElementById('auctionGroup').value || null;
        var duration = Math.max(30, parseInt(document.getElementById('auctionDuration').value, 10) || 120);
        var itemType = document.getElementById('auctionItemType').value || 'auction';
        var stock = Math.max(1, parseInt(document.getElementById('auctionStock').value, 10) || 1);
        if (!name) { showToast('Enter an item name.', 'danger'); return; }
        if (name.length > 120) { showToast('Item name is too long (max 120)', 'danger'); return; }
        var btn = document.getElementById('btnCreateAuction');
        createAuctionBusy = true;
        if (btn) { btn.disabled = true; btn.textContent = 'Publishing...'; }
        createAuction(name, desc || null, price, 'active', {
            item_type: itemType,
            stock_quantity: itemType === 'shop' ? stock : 1,
            group_code: groupCode,
            duration_seconds: itemType === 'auction' ? duration : 86400
        }).then(function() {
            document.getElementById('auctionItemName').value = '';
            document.getElementById('auctionDescription').value = '';
            document.getElementById('auctionBasePrice').value = '';
            document.getElementById('auctionDuration').value = '120';
            document.getElementById('auctionStock').value = '1';
            window.loadAuctionList();
            showToast(itemType === 'shop' ? 'Shop item published' : 'Auction launched', 'success');
        }).catch(function(e) {
            logUiError('AUCTION_CREATE_ERROR', e);
            showToast('Error creating auction: ' + (e.message || 'Try again.'), 'danger');
        }).finally(function() {
            createAuctionBusy = false;
            if (btn) { btn.disabled = false; btn.textContent = 'Publish Item'; }
        });
    };
    document.getElementById('btnCreateAuction').addEventListener('click', window.createAuctionItem);

    window.closeAuctionAdmin = function(auctionId) {
        if (!confirm('Close this auction now?')) return;
        closeAuction(auctionId).then(function(result) {
            if (!result.ok) {
                showToast('Error closing auction: ' + (result.error || 'Unknown'), 'danger');
                return;
            }
            showToast(result.warning || ('Auction closed. Winner: ' + (result.winnerName || 'No winner')), 'success');
            window.loadAuctionList();
        }).catch(function(e) {
            logUiError('AUCTION_CLOSE_ERROR', e);
            showToast('Failed to close auction', 'danger');
        });
    };

    window.loadAuctionList = function() {
        console.log('[ADMIN] Loading auction list...');
        closeExpiredAuctions().then(function() {
            return supabaseClient
                .from(CONFIG.tables.auctions)
                .select('*')
                .order('created_at', { ascending: false })
                .limit(30);
        }).then(function(result) {
            var list = result.data || [];
            console.log('[ADMIN] Auctions loaded:', list ? list.length : 0);
            var el = document.getElementById('auctionList');
            if (!list || !list.length) { el.innerHTML = '<p class="text-muted small">No auctions yet. Create one above.</p>'; return; }
            Promise.all(list.map(function(a) {
                return getAuctionBids(a.id).then(function(bids) {
                    var bidsHtml = !bids.length
                        ? '<div class="small text-muted mt-2">No bids yet.</div>'
                        : '<div class="mt-2"><strong class="small">Live bids</strong><ul class="small mb-0">' + bids.slice(0, 10).map(function(b) {
                            var ts = b.created_at ? new Date(b.created_at).toLocaleTimeString() : '-';
                            return '<li>' + escapeHtml(b.bidder_name || b.bidder_id || 'Unknown') + ': <strong>' + (b.bid_amount || 0) + ' coins</strong> <span class="text-muted">(' + escapeHtml(ts) + ')</span></li>';
                        }).join('') + '</ul></div>';
                    var leaderName = a.highest_bidder_name || (a.highest_bidder_id ? ('ID ' + a.highest_bidder_id) : null);
                    var closeBtn = a.status === 'active'
                        ? '<button class="btn btn-sm btn-danger" onclick="closeAuctionAdmin(\'' + a.id + '\')">Close</button>'
                        : '<span class="badge bg-secondary">Closed</span>';
                    var deleteBtn = (a.status === 'closed' || a.status === 'finished')
                        ? '<button class="btn btn-sm btn-outline-danger" onclick="deleteAuctionAdmin(\'' + a.id + '\',\'' + String(a.status || '').replace(/'/g, "\\'") + '\')">Delete</button>'
                        : '';
                    return '<div class="auction-card">' +
                        '<div class="d-flex justify-content-between align-items-center gap-2">' +
                        '<strong>' + escapeHtml(a.item_name || '') + '</strong>' +
                        '<span class="badge ' + (a.status === 'active' ? 'bg-success' : 'bg-secondary') + '">' + (a.status === 'active' ? 'Active' : 'Closed') + '</span>' +
                        '</div>' +
                        (a.description ? '<p class="small text-muted mb-1">' + escapeHtml(a.description) + '</p>' : '') +
                        (leaderName ? '<div class="small"><strong>Leader:</strong> ' + escapeHtml(leaderName) + '</div>' : '') +
                        bidsHtml +
                        '<div class="mt-2 d-flex gap-2">' + closeBtn + ' ' + deleteBtn + '</div>' +
                        '</div>';
                });
            })).then(function(cards) {
                el.innerHTML = cards.join('');
            });
        }).catch(function(e) {
            logUiError('AUCTION_LIST_LOAD_ERROR', e);
            showToast('Failed to load auctions', 'danger');
        });
    };

    // Polling for admin auction list
    var adminAuctionPollingInterval = null;
    function startAdminAuctionPolling() {
        if (adminAuctionPollingInterval) clearInterval(adminAuctionPollingInterval);
        adminAuctionPollingInterval = setInterval(function() {
            if (document.getElementById('auctionList')) {
                window.loadAuctionList();
            } else {
                clearInterval(adminAuctionPollingInterval);
                adminAuctionPollingInterval = null;
            }
        }, 2500);
    }
    function stopAdminAuctionPolling() {
        if (adminAuctionPollingInterval) {
            clearInterval(adminAuctionPollingInterval);
            adminAuctionPollingInterval = null;
        }
    }

    window.loadFeedbackList = function() {
        console.log('[ADMIN] Loading feedback list...');
        getFeedbackMessages().then(function(messages) {
            console.log('[ADMIN] Feedback messages loaded:', messages ? messages.length : 0);
            var el = document.getElementById('feedbackList');
            if (!messages || !messages.length) { el.innerHTML = '<p class="text-muted small">No feedback messages yet.</p>'; return; }
            var html = messages.map(function(m) {
                var statusBadge = m.status === 'new' ? '<span class="badge bg-warning">New</span>' : 
                                 m.status === 'read' ? '<span class="badge bg-info">Read</span>' : 
                                 '<span class="badge bg-secondary">Archived</span>';
                var emailInfo = m.email ? '<div class="small text-muted">Email: ' + escapeHtml(m.email) + '</div>' : '';
                var actions = m.status === 'new' ? '<button class="btn btn-sm btn-outline-info me-1" onclick="markFeedbackStatus(\'' + m.id + '\', \'read\')">Mark as read</button>' : 
                              m.status === 'read' ? '<button class="btn btn-sm btn-outline-secondary me-1" onclick="markFeedbackStatus(\'' + m.id + '\', \'archived\')">Archive</button>' : '';
                return '<div class="feedback-card">' +
                    '<div class="d-flex justify-content-between align-items-start mb-2">' +
                    '<strong>' + escapeHtml(m.student_name || m.student_id || 'Unknown') + '</strong>' +
                    statusBadge +
                    '</div>' +
                    (m.group_code ? '<div class="small text-muted">Group: ' + escapeHtml(m.group_code) + '</div>' : '') +
                    emailInfo +
                    '<div class="small text-muted">' + (m.created_at ? new Date(m.created_at).toLocaleString() : '') + '</div>' +
                    '<div class="mt-2">' + escapeHtml(m.message) + '</div>' +
                    (actions ? '<div class="mt-2">' + actions + '</div>' : '') +
                    '</div>';
            }).join('');
            el.innerHTML = html;
        }).catch(function(e) {
            logUiError('FEEDBACK_LIST_LOAD_ERROR', e);
            showToast('Failed to load feedback', 'danger');
        });
    };

    window.markFeedbackStatus = function(messageId, status) {
        updateFeedbackStatus(messageId, status).then(function(result) {
            if (!result.ok) {
                showToast('Error updating feedback: ' + (result.error || 'Unknown'), 'danger');
                return;
            }
            showToast('Feedback updated', 'success');
            window.loadFeedbackList();
        }).catch(function(e) {
            logUiError('FEEDBACK_STATUS_UPDATE_ERROR', e);
            showToast('Failed to update feedback', 'danger');
        });
    };

    async function getInstitutionsWithTeacherCounts() {
        var instResult = await supabaseClient
            .from(CONFIG.tables.institutions)
            .select('id,name,subscription_plan,ai_credit_pool,ai_generation_limit,active_ai_provider,active_ai_key')
            .order('name');

        if (instResult.error && isMissingColumnError(instResult.error, 'ai_generation_limit', CONFIG.tables.institutions)) {
            instResult = await supabaseClient
                .from(CONFIG.tables.institutions)
                .select('id,name,subscription_plan,ai_credit_pool,active_ai_provider,active_ai_key')
                .order('name');
        }

        if (instResult.error && (isMissingColumnError(instResult.error, 'active_ai_provider', CONFIG.tables.institutions)
            || isMissingColumnError(instResult.error, 'active_ai_key', CONFIG.tables.institutions))) {
            instResult = await supabaseClient
                .from(CONFIG.tables.institutions)
                .select('id,name,subscription_plan,ai_credit_pool,ai_generation_limit')
                .order('name');
        }

        if (instResult.error && isMissingColumnError(instResult.error, 'ai_credit_pool', CONFIG.tables.institutions)) {
            instResult = await supabaseClient
                .from(CONFIG.tables.institutions)
                .select('id,name,subscription_plan,ai_generation_limit')
                .order('name');
        }

        if (instResult.error && isMissingColumnError(instResult.error, 'ai_generation_limit', CONFIG.tables.institutions)) {
            instResult = await supabaseClient
                .from(CONFIG.tables.institutions)
                .select('id,name,subscription_plan')
                .order('name');
        }
        if (instResult.error && isMissingColumnError(instResult.error, 'ai_credit_pool', CONFIG.tables.institutions)) {
            instResult = await supabaseClient
                .from(CONFIG.tables.institutions)
                .select('id,name,subscription_plan,ai_generation_limit')
                .order('name');
        }
        if (instResult.error) throw instResult.error;

        var institutions = (instResult.data || []).map(function(i) {
            return {
                id: i.id,
                name: i.name || 'Unnamed',
                subscription_plan: i.subscription_plan || 'BASIC',
                ai_limit: (i.ai_credit_pool != null ? i.ai_credit_pool : (i.ai_generation_limit != null ? i.ai_generation_limit : 10)),
                active_ai_provider: i.active_ai_provider || 'anthropic',
                active_ai_key: i.active_ai_key || ''
            };
        });

        var teacherCountByInstitution = {};
        try {
            var teacherRes = await supabaseClient
                .from(CONFIG.tables.profiles)
                .select('institution_id, rol')
                .eq('rol', 'teacher');
            if (!teacherRes.error) {
                (teacherRes.data || []).forEach(function(t) {
                    var key = String(t.institution_id || '');
                    if (!key) return;
                    teacherCountByInstitution[key] = (teacherCountByInstitution[key] || 0) + 1;
                });
            }
        } catch (_) {}

        institutions.forEach(function(i) {
            i.active_teachers = teacherCountByInstitution[String(i.id)] || 0;
        });
        return institutions;
    }

    window.saveInstitutionAIConfig = async function(institutionId) {
        if (!isSuperAdmin) {
            showToast('Only super_admin can set API keys', 'danger');
            return;
        }
        var providerEl = document.getElementById('instProvider-' + institutionId);
        var keyEl = document.getElementById('instKey-' + institutionId);
        var statusEl = document.getElementById('instStatus-' + institutionId);
        if (!providerEl || !keyEl) return;
        var provider = String(providerEl.value || 'anthropic').trim().toLowerCase();
        var apiKey = String(keyEl.value || '').trim();

        var upd = await supabaseClient
            .from(CONFIG.tables.institutions)
            .update({ active_ai_provider: provider, active_ai_key: apiKey })
            .eq('id', institutionId);
        if (upd.error && (isMissingColumnError(upd.error, 'active_ai_provider', CONFIG.tables.institutions)
            || isMissingColumnError(upd.error, 'active_ai_key', CONFIG.tables.institutions))) {
            throw new Error('Missing columns active_ai_provider/active_ai_key. Run migration first.');
        }
        if (upd.error) throw upd.error;
        if (statusEl) statusEl.innerHTML = '<span class="text-success">Saved</span>';
        showToast('Institution AI config updated', 'success');
    };

    window.loadInstitutionsView = async function() {
        var el = document.getElementById('institutionsList');
        if (!el) return;
        if (!isSuperAdmin) {
            el.innerHTML = '<div class="alert alert-danger">Access denied</div>';
            return;
        }
        el.innerHTML = '<p class="text-muted small">Loading institutions...</p>';
        try {
            var rows = await getInstitutionsWithTeacherCounts();
            if (!rows.length) {
                el.innerHTML = '<p class="text-muted small">No institutions found.</p>';
                return;
            }
            var instOptions = rows.map(function(r) {
                return '<option value="' + escapeAttr(String(r.id || '')) + '">' + escapeHtml(r.name || '-') + '</option>';
            }).join('');

            var uisId = '';
            rows.forEach(function(r) {
                if (String(r.name || '').trim().toLowerCase() === 'uis') uisId = String(r.id || '');
            });

            el.innerHTML = '<div class="admin-table-wrap"><table class="table table-sm"><thead><tr><th>Institution</th><th>Plan</th><th>AI Limit</th><th>Active Teachers</th><th>API Keys</th></tr></thead><tbody>' +
                rows.map(function(r) {
                    var iid = String(r.id || '');
                    var keyMasked = r.active_ai_key ? '********' : '';
                    return '<tr>' +
                        '<td>' + escapeHtml(r.name || '-') + '</td>' +
                        '<td>' + escapeHtml(r.subscription_plan || '-') + '</td>' +
                        '<td>' + escapeHtml(String(r.ai_limit != null ? r.ai_limit : '-')) + '</td>' +
                        '<td>' + escapeHtml(String(r.active_teachers || 0)) + '</td>' +
                        '<td>' +
                        '<div class="d-flex flex-column gap-1" style="min-width:280px;">' +
                        '<select id="instProvider-' + escapeAttr(iid) + '" class="form-select form-select-sm">' +
                        '<option value="anthropic"' + ((r.active_ai_provider || '').toLowerCase() === 'anthropic' ? ' selected' : '') + '>anthropic</option>' +
                        '<option value="openai"' + ((r.active_ai_provider || '').toLowerCase() === 'openai' ? ' selected' : '') + '>openai</option>' +
                        '<option value="gemini"' + ((r.active_ai_provider || '').toLowerCase() === 'gemini' ? ' selected' : '') + '>gemini</option>' +
                        '</select>' +
                        '<input id="instKey-' + escapeAttr(iid) + '" type="password" class="form-control form-control-sm" value="' + escapeAttr(r.active_ai_key || '') + '" placeholder="API key">' +
                        '<div class="d-flex align-items-center gap-2"><button class="btn btn-sm btn-primary" onclick="saveInstitutionAIConfig(\'' + String(iid).replace(/'/g, "\\'") + '\')">Save</button><span id="instStatus-' + escapeAttr(iid) + '" class="small text-muted">' + escapeHtml(keyMasked) + '</span></div>' +
                        '</div>' +
                        '</td>' +
                        '</tr>';
                }).join('') +
                '</tbody></table></div>' +

                '<div class="mt-3 p-3" style="border:1px solid rgba(255,255,255,0.12); border-radius:12px;">' +
                '<div class="d-flex flex-column gap-2">' +
                '<div class="fw-bold">Institution admin tools (super_admin)</div>' +

                '<div class="d-flex gap-2 flex-wrap">' +
                '<input id="newInstitutionName" type="text" class="form-control" placeholder="New institution name (e.g. UIS)" style="max-width:320px;">' +
                '<button class="btn btn-success" onclick="createInstitutionFromUI()">Create Institution</button>' +
                '<span id="createInstitutionStatus" class="small text-muted"></span>' +
                '</div>' +

                '<div class="d-flex gap-2 flex-wrap align-items-center">' +
                '<label class="small text-muted" style="min-width:120px;">Target institution</label>' +
                '<select id="targetInstitutionSelect" class="form-select" style="max-width:360px;">' + instOptions + '</select>' +
                '<button class="btn btn-outline-secondary" onclick="refreshInstitutionPeople()">Refresh People</button>' +
                '<span id="institutionPeopleStatus" class="small text-muted"></span>' +
                '</div>' +

                '<div class="d-flex gap-2 flex-wrap">' +
                '<input id="assignUserDocumento" type="text" class="form-control" placeholder="User documento_id to assign" style="max-width:240px;">' +
                '<button class="btn btn-primary" onclick="assignUserToInstitutionFromUI()">Assign User</button>' +
                '<span id="assignUserStatus" class="small text-muted"></span>' +
                '</div>' +

                '<div class="d-flex gap-2 flex-wrap align-items-center">' +
                '<label class="small text-muted" style="min-width:120px;">Bulk move from</label>' +
                '<select id="bulkFromInstitutionSelect" class="form-select" style="max-width:360px;">' + instOptions + '</select>' +
                '<label class="small text-muted">Roles</label>' +
                '<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="bulkRoleStudents" checked><label class="form-check-label" for="bulkRoleStudents">students</label></div>' +
                '<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="bulkRoleTeachers" checked><label class="form-check-label" for="bulkRoleTeachers">teachers</label></div>' +
                '<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="bulkRoleAdmins" checked><label class="form-check-label" for="bulkRoleAdmins">admins</label></div>' +
                '<button class="btn btn-warning" onclick="bulkMoveUsersFromUI()">Bulk Move</button>' +
                '<span id="bulkMoveStatus" class="small text-muted"></span>' +
                '</div>' +

                '<div class="small text-muted">Tip: To create UIS quickly, type <b>UIS</b> and click Create. Then choose UIS in Target institution and assign Christian admin + teachers/students.</div>' +
                '</div>' +

                '<div class="mt-3">' +
                '<div class="fw-bold mb-2">Admins & teachers in selected institution</div>' +
                '<div id="institutionPeopleList"><div class="small text-muted">Select an institution and click Refresh People.</div></div>' +
                '</div>' +
                '</div>';

            // auto-select UIS if present
            try {
                if (uisId) {
                    var targetSel = document.getElementById('targetInstitutionSelect');
                    var bulkFromSel = document.getElementById('bulkFromInstitutionSelect');
                    if (targetSel) targetSel.value = uisId;
                    if (bulkFromSel) bulkFromSel.value = uisId;
                }
            } catch (_) {}
        } catch (e) {
            logUiError('INSTITUTIONS_LOAD_ERROR', e);
            el.innerHTML = '<div class="alert alert-danger">Error loading institutions: ' + escapeHtml(e.message || 'Unknown') + '</div>';
        }
    };

    async function getInstitutionByNameExact(name) {
        var nm = String(name || '').trim();
        if (!nm) return null;
        var res = await supabaseClient
            .from(CONFIG.tables.institutions)
            .select('id,name')
            .eq('name', nm)
            .maybeSingle();
        if (res.error) throw res.error;
        return res.data || null;
    }

    window.createInstitutionFromUI = async function() {
        if (!isSuperAdmin) return;
        var nameEl = document.getElementById('newInstitutionName');
        var statusEl = document.getElementById('createInstitutionStatus');
        var name = nameEl ? String(nameEl.value || '').trim() : '';
        if (!name) { showToast('Enter institution name', 'danger'); return; }
        if (statusEl) statusEl.textContent = 'Creating...';
        try {
            var existing = await getInstitutionByNameExact(name);
            if (existing && existing.id) {
                if (statusEl) statusEl.innerHTML = '<span class="text-success">Already exists</span>';
                showToast('Institution already exists: ' + name, 'info');
                await window.loadInstitutionsView();
                return;
            }

            var ins = await supabaseClient
                .from(CONFIG.tables.institutions)
                .insert([{ name: name, subscription_plan: 'BASIC', ai_credit_pool: 10, ai_credits_used: 0, active_ai_provider: 'anthropic' }])
                .select('id,name')
                .maybeSingle();
            if (ins.error && isMissingColumnError(ins.error, 'ai_credit_pool', CONFIG.tables.institutions)) {
                ins = await supabaseClient
                    .from(CONFIG.tables.institutions)
                    .insert([{ name: name, subscription_plan: 'BASIC', ai_generation_limit: 10, ai_generations_used: 0 }])
                    .select('id,name')
                    .maybeSingle();
            }
            if (ins.error && isMissingColumnError(ins.error, 'active_ai_provider', CONFIG.tables.institutions)) {
                ins = await supabaseClient
                    .from(CONFIG.tables.institutions)
                    .insert([{ name: name, subscription_plan: 'BASIC' }])
                    .select('id,name')
                    .maybeSingle();
            }
            if (ins.error) throw ins.error;
            if (statusEl) statusEl.innerHTML = '<span class="text-success">Created</span>';
            showToast('Institution created: ' + name, 'success');
            await window.loadInstitutionsView();
        } catch (e) {
            if (statusEl) statusEl.innerHTML = '<span class="text-danger">' + escapeHtml(e.message || 'Error') + '</span>';
            showToast('Create institution failed: ' + (e.message || 'Unknown'), 'danger');
        }
    };

    async function lookupProfileByDocumento(documentoId) {
        var doc = String(documentoId || '').trim();
        if (!doc) return null;
        var res = await supabaseClient
            .from(CONFIG.tables.profiles)
            .select('id,documento_id,nombre_completo,rol,institution_id')
            .eq('documento_id', doc)
            .maybeSingle();
        if (res.error) throw res.error;
        return res.data || null;
    }

    window.assignUserToInstitutionFromUI = async function() {
        if (!isSuperAdmin) return;
        var docEl = document.getElementById('assignUserDocumento');
        var targetSel = document.getElementById('targetInstitutionSelect');
        var statusEl = document.getElementById('assignUserStatus');
        var doc = docEl ? String(docEl.value || '').trim() : '';
        var instId = targetSel ? String(targetSel.value || '').trim() : '';
        if (!doc) { showToast('Enter documento_id', 'danger'); return; }
        if (!instId) { showToast('Select target institution', 'danger'); return; }
        if (statusEl) statusEl.textContent = 'Assigning...';
        try {
            var prof = await lookupProfileByDocumento(doc);
            if (!prof || !prof.id) throw new Error('User not found for documento_id: ' + doc);
            await editAnyUser(prof.id, { institution_id: instId });
            if (statusEl) statusEl.innerHTML = '<span class="text-success">Assigned</span>';
            showToast('Assigned ' + (prof.nombre_completo || doc) + ' to institution', 'success');
            await refreshInstitutionPeople();
        } catch (e) {
            if (statusEl) statusEl.innerHTML = '<span class="text-danger">' + escapeHtml(e.message || 'Error') + '</span>';
            showToast('Assign failed: ' + (e.message || 'Unknown'), 'danger');
        }
    };

    window.bulkMoveUsersFromUI = async function() {
        if (!isSuperAdmin) return;
        var fromSel = document.getElementById('bulkFromInstitutionSelect');
        var toSel = document.getElementById('targetInstitutionSelect');
        var statusEl = document.getElementById('bulkMoveStatus');
        var fromId = fromSel ? String(fromSel.value || '').trim() : '';
        var toId = toSel ? String(toSel.value || '').trim() : '';
        if (!fromId || !toId) { showToast('Select from/to institutions', 'danger'); return; }
        if (fromId === toId) { showToast('From and To cannot be the same', 'danger'); return; }

        var roles = [];
        if (document.getElementById('bulkRoleStudents') && document.getElementById('bulkRoleStudents').checked) roles.push('student');
        if (document.getElementById('bulkRoleTeachers') && document.getElementById('bulkRoleTeachers').checked) roles.push('teacher');
        if (document.getElementById('bulkRoleAdmins') && document.getElementById('bulkRoleAdmins').checked) roles.push('admin');
        if (!roles.length) { showToast('Select at least one role', 'danger'); return; }

        if (!confirm('Bulk move ' + roles.join(', ') + ' from one institution to another?')) return;
        if (statusEl) statusEl.textContent = 'Moving...';
        try {
            var res = await supabaseClient
                .from(CONFIG.tables.profiles)
                .select('id, rol')
                .eq('institution_id', fromId)
                .in('rol', roles);
            if (res.error && isMissingColumnError(res.error, 'institution_id', CONFIG.tables.profiles)) {
                throw new Error('profiles.institution_id column missing. Run migration first.');
            }
            if (res.error) throw res.error;
            var ids = (res.data || []).map(function(r) { return r.id; }).filter(Boolean);
            var moved = 0;
            for (var i = 0; i < ids.length; i++) {
                await editAnyUser(ids[i], { institution_id: toId });
                moved++;
            }
            if (statusEl) statusEl.innerHTML = '<span class="text-success">Moved ' + moved + ' users</span>';
            showToast('Bulk move complete: ' + moved, 'success');
            await refreshInstitutionPeople();
            await window.loadInstitutionsView();
        } catch (e) {
            if (statusEl) statusEl.innerHTML = '<span class="text-danger">' + escapeHtml(e.message || 'Error') + '</span>';
            showToast('Bulk move failed: ' + (e.message || 'Unknown'), 'danger');
        }
    };

    window.refreshInstitutionPeople = async function() {
        if (!isSuperAdmin) return;
        var targetSel = document.getElementById('targetInstitutionSelect');
        var listEl = document.getElementById('institutionPeopleList');
        var statusEl = document.getElementById('institutionPeopleStatus');
        var instId = targetSel ? String(targetSel.value || '').trim() : '';
        if (!instId) return;
        if (statusEl) statusEl.textContent = 'Loading...';
        try {
            var res = await supabaseClient
                .from(CONFIG.tables.profiles)
                .select('id,documento_id,nombre_completo,rol')
                .eq('institution_id', instId)
                .in('rol', ['admin', 'teacher'])
                .order('rol', { ascending: true })
                .order('nombre_completo', { ascending: true });
            if (res.error && isMissingColumnError(res.error, 'institution_id', CONFIG.tables.profiles)) {
                throw new Error('profiles.institution_id column missing. Run migration first.');
            }
            if (res.error) throw res.error;
            var rows = res.data || [];
            if (!rows.length) {
                if (listEl) listEl.innerHTML = '<div class="small text-muted">No admins/teachers in this institution.</div>';
            } else {
                var html = '<div class="admin-table-wrap"><table class="table table-sm"><thead><tr><th>Role</th><th>Name</th><th>Documento</th><th>Quick actions</th></tr></thead><tbody>';
                rows.forEach(function(p) {
                    var pid = String(p.id || '').replace(/'/g, "\\'");
                    html += '<tr>' +
                        '<td>' + escapeHtml(p.rol || '-') + '</td>' +
                        '<td>' + escapeHtml(p.nombre_completo || '-') + '</td>' +
                        '<td>' + escapeHtml(p.documento_id || '-') + '</td>' +
                        '<td>' +
                        '<button class="btn btn-sm btn-outline-primary me-1" onclick="openEdit(\'' + pid + '\',\'' + String(p.nombre_completo || '').replace(/'/g, "\\'") + '\',\'' + String(p.documento_id || '').replace(/'/g, "\\'") + '\',\'\',\'\',\'' + String(p.rol || '').replace(/'/g, "\\'") + '\')">Edit</button>' +
                        '</td>' +
                        '</tr>';
                });
                html += '</tbody></table></div>';
                if (listEl) listEl.innerHTML = html;
            }
            if (statusEl) statusEl.innerHTML = '<span class="text-success">Loaded</span>';
        } catch (e) {
            if (listEl) listEl.innerHTML = '<div class="alert alert-danger">' + escapeHtml(e.message || 'Error') + '</div>';
            if (statusEl) statusEl.innerHTML = '<span class="text-danger">Error</span>';
        }
    };

    (async function init() {
        console.log('[ADMIN INIT] Starting admin panel initialization...');
        console.log('[ADMIN INIT] User:', user.nombre_completo, '| Role:', user.rol);
        
        try {
            var groups = await getGroupsFiltered(user);
            if (isTeacherRole) {
                // Do NOT force user.grupo ‚Äî teachers may have multiple groups via teacher_groups.
                // Fallback only if teacher_groups is missing or empty.
                var ownGroup = String(user.grupo || '').trim();
                if ((!groups || !groups.length) && ownGroup) groups = [{ group_code: ownGroup }];
            }
            window._editGroups = groups || [];
            var select = document.getElementById('adminGroupFilter');
            var qrSelect = document.getElementById('qrGroup');

            if (select) select.innerHTML = isTeacherRole ? '<option value="">My group</option>' : '<option value="">All groups</option>';
            if (qrSelect) qrSelect.innerHTML = '<option value="">Select group</option>';
            var auctionGroup = document.getElementById('auctionGroup');
            if (auctionGroup) auctionGroup.innerHTML = '<option value="">All groups</option>';

            (groups || []).forEach(function(g) {
                [select, qrSelect, auctionGroup].forEach(function(s) {
                    if (!s) return;
                    var opt = document.createElement('option');
                    opt.value = g.group_code;
                    opt.textContent = g.group_code;
                    s.appendChild(opt);
                });
            });
            if (isTeacherRole && select && (!groups || !groups.length)) {
                var noOpt = document.createElement('option');
                noOpt.value = '';
                noOpt.textContent = 'No groups assigned to your account';
                select.appendChild(noOpt);
            }

            if (isTeacherRole) {
                var teacherCodesOnly = (groups || []).map(function(g) { return String(g.group_code || ''); }).filter(Boolean);
                selectedTeacherGroup = teacherCodesOnly.length ? teacherCodesOnly[0] : '';
                if (select) select.value = selectedTeacherGroup;
                if (select) select.disabled = true;
                if (qrSelect) {
                    qrSelect.value = selectedTeacherGroup;
                    qrSelect.disabled = false;
                }
                renderTeacherGroupTabs(teacherCodesOnly);
                loadTeacherPocket();
                loadTeacherWalletHistory();
                await loadTeacherAbsenceAlerts(selectedTeacherGroup, false);
                loadTeacherDashboard();
            }

            // Light auto-refresh so Admin allocations show up without a full reload.
            if (isTeacherRole && !window.__teacherPocketTimer) {
                window.__teacherPocketTimer = setInterval(function() {
                    try { loadTeacherPocket(); } catch (_) {}
                }, 15000);
            }

            var announcementGroupSelect = document.getElementById('announcementGroup');
            var challengeTargetSelect = document.getElementById('challengeTargetGroup');
            if (groups && groups.length) {
                groups.forEach(function(g) {
                    [announcementGroupSelect, challengeTargetSelect].forEach(function(s) {
                        if (!s) return;
                        var opt = document.createElement('option');
                        opt.value = g.group_code;
                        opt.textContent = g.group_code;
                        s.appendChild(opt);
                    });
                });
            }

            if (isTeacherRole) {
                var groupCreateControls = document.getElementById('groupCreateControls');
                if (groupCreateControls) groupCreateControls.style.display = 'none';
                window.refreshStudents();
            }

            if (isSchoolAdmin || isTeacherRole) {
                window.loadGroupsList();
            }

            if (isSuperAdmin) {
                window.loadInstitutionsView();
            }

            if (userAllowedViews.indexOf(initialAdminView) !== -1) {
                window.showAdminView(initialAdminView);
            }

            challengeBuilderState = [defaultChallengeQuestion('multiple_choice')];
            renderChallengeBuilder();
        } catch (e) {
            console.error('[ADMIN INIT] Failed:', e);
            showToast('Failed to initialize admin panel: ' + (e.message || 'Unknown error'), 'danger');
        }
    })();
    
    // ========== GROUPS MANAGEMENT ==========
    window.loadGroupsList = function() {
        getGroupsFiltered(user).then(async function(groups) {
            var el = document.getElementById('groupsList');
            if (!groups || !groups.length) {
                el.innerHTML = '<p class="text-muted small">No groups available for your role.</p>';
                return;
            }

            var groupCodes = groups.map(function(g) { return g.group_code; });
            var studentsByGroup = {};
            var teachersByGroup = {};

            try {
                var studentsRes = await supabaseClient.from(CONFIG.tables.profiles)
                    .select('grupo')
                    .eq('rol', 'student')
                    .in('grupo', groupCodes);
                if (!studentsRes.error) {
                    (studentsRes.data || []).forEach(function(s) {
                        var gc = String(s.grupo || '');
                        studentsByGroup[gc] = (studentsByGroup[gc] || 0) + 1;
                    });
                }
            } catch (_) {}

            try {
                var tgRes = await supabaseClient.from(CONFIG.tables.teacher_groups)
                    .select('teacher_id,group_code')
                    .in('group_code', groupCodes);
                if (!tgRes.error) {
                    var teacherIds = [];
                    (tgRes.data || []).forEach(function(r) {
                        if (teacherIds.indexOf(r.teacher_id) === -1) teacherIds.push(r.teacher_id);
                    });
                    var teacherNameById = {};
                    if (teacherIds.length) {
                        var tpRes = await supabaseClient.from(CONFIG.tables.profiles)
                            .select('id,nombre_completo')
                            .in('id', teacherIds);
                        if (!tpRes.error) {
                            (tpRes.data || []).forEach(function(t) {
                                teacherNameById[String(t.id)] = t.nombre_completo || 'Teacher';
                            });
                        }
                    }
                    (tgRes.data || []).forEach(function(r) {
                        var gc = String(r.group_code || '');
                        if (!teachersByGroup[gc]) teachersByGroup[gc] = [];
                        var nm = teacherNameById[String(r.teacher_id)] || 'Teacher';
                        if (teachersByGroup[gc].indexOf(nm) === -1) teachersByGroup[gc].push(nm);
                    });
                }
            } catch (_) {}

            var controls = document.getElementById('groupCreateControls');
            // Teacher needs Groups CRUD per request.
            if (controls) controls.style.display = '';

            el.innerHTML = '<div class="admin-table-wrap"><table class="table table-sm"><thead><tr>' +
                '<th>Group</th><th>Teacher Assigned</th><th>Students</th><th style="width:260px;">Actions</th>' +
                '</tr></thead><tbody>' +
                groups.map(function(g) {
                    var gc = String(g.group_code || '');
                    var teachers = teachersByGroup[gc] && teachersByGroup[gc].length ? teachersByGroup[gc].join(', ') : '-';
                    var students = studentsByGroup[gc] || 0;
                    var cap = (g.max_capacity != null) ? g.max_capacity : ((g.capacity != null) ? g.capacity : '');
                    var lat = g.last_admin_lat != null ? g.last_admin_lat : '';
                    var lng = g.last_admin_lng != null ? g.last_admin_lng : '';
                    var safeGc = gc.replace(/'/g, "\\'");
                    return '<tr>' +
                        '<td class="cell-ellipsis" title="' + escapeAttr(gc) + '"><strong>' + escapeHtml(gc) + '</strong></td>' +
                        '<td class="cell-ellipsis" title="' + escapeAttr(teachers) + '">' + escapeHtml(teachers) + '</td>' +
                        '<td>' + escapeHtml(String(students)) + '</td>' +
                        '<td class="d-flex gap-1 flex-wrap">' +
                            '<button type="button" class="btn btn-sm btn-outline-primary" onclick="(function(){ window.showAdminView(\'users\'); var sel=document.getElementById(\'adminGroupFilter\'); if(sel) sel.value=\'' + escapeAttr(gc) + '\'; if(window.refreshStudents) window.refreshStudents(); })()">Students</button>' +
                            '<button type="button" class="btn btn-sm btn-outline-secondary" onclick="openGroupEdit(\'' + escapeAttr(gc) + '\',' + (cap === '' ? 'null' : Number(cap)) + ',' + (lat === '' ? 'null' : Number(lat)) + ',' + (lng === '' ? 'null' : Number(lng)) + ')">Edit</button>' +
                            '<button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteGroupConfirm(\'' + escapeAttr(gc) + '\')">Delete</button>' +
                        '</td>' +
                        '</tr>';
                }).join('') +
                '</tbody></table></div>';
        }).catch(function(e) {
            console.error('[ADMIN] Failed to load groups:', e);
        });
    };
    
    document.getElementById('btnCreateGroupView').addEventListener('click', function() {
        var code = document.getElementById('newGroupCodeInput').value.trim();
        var capacity = parseInt(document.getElementById('newGroupCapacity').value) || null;
        if (!code) { showToast('Enter a group code', 'danger'); return; }
        insertGroup(code, capacity).then(function() {
            document.getElementById('newGroupCodeInput').value = '';
            document.getElementById('newGroupCapacity').value = '';
            window.loadGroupsList();
            showToast('Group created', 'success');
        }).catch(function(e) {
            logUiError('GROUP_CREATE_VIEW_ERROR', e);
            showToast('Error creating group: ' + (e.message || 'Unknown'), 'danger');
        });
    });
    
    window.deleteGroupConfirm = function(groupCode) {
        if (!confirm('Delete group "' + groupCode + '"? This cannot be undone.')) return;
        deleteGroupSafe(groupCode).then(function(result) {
            if (!result.ok) {
                showToast('Error: ' + (result.error || 'Could not delete group'), 'danger');
                return;
            }
            window.loadGroupsList();
            showToast('Group deleted', 'success');
        });
    };

    window.openGroupEdit = function(groupCode, maxCapacity, lat, lng) {
        document.getElementById('editGroupOldCode').value = groupCode || '';
        document.getElementById('editGroupCode').value = groupCode || '';
        document.getElementById('editGroupCapacity').value = maxCapacity == null ? '' : maxCapacity;
        document.getElementById('editGroupLat').value = lat == null ? '' : lat;
        document.getElementById('editGroupLng').value = lng == null ? '' : lng;
        if (!groupEditModalEl) groupEditModalEl = new bootstrap.Modal(document.getElementById('groupEditModal'));
        groupEditModalEl.show();
    };

    document.getElementById('btnSaveGroupEdit').addEventListener('click', function() {
        var oldCode = document.getElementById('editGroupOldCode').value;
        var groupCode = document.getElementById('editGroupCode').value.trim();
        var capacity = document.getElementById('editGroupCapacity').value;
        var lat = document.getElementById('editGroupLat').value;
        var lng = document.getElementById('editGroupLng').value;
        if (!groupCode) { showToast('Group code is required', 'danger'); return; }

        updateGroupSafe(oldCode, {
            group_code: groupCode,
            max_capacity: capacity,
            last_admin_lat: lat,
            last_admin_lng: lng
        }).then(function(result) {
            if (!result.ok) {
                showToast('Error saving group: ' + (result.error || 'Unknown'), 'danger');
                return;
            }
            if (groupEditModalEl) groupEditModalEl.hide();
            window.loadGroupsList();
            getGroups().then(function(groups) {
                window._editGroups = groups || [];
                var selectors = ['adminGroupFilter', 'qrGroup', 'auctionGroup', 'announcementGroup', 'challengeTargetGroup'];
                selectors.forEach(function(selId) {
                    var sel = document.getElementById(selId);
                    if (!sel) return;
                    var currentVal = sel.value;
                    sel.innerHTML = (selId === 'adminGroupFilter' || selId === 'auctionGroup' || selId === 'announcementGroup' || selId === 'challengeTargetGroup')
                        ? '<option value="">All groups</option>'
                        : '<option value="">Select group</option>';
                    groups.forEach(function(g) {
                        var opt = document.createElement('option');
                        opt.value = g.group_code;
                        opt.textContent = g.group_code;
                        if (g.group_code === currentVal) opt.selected = true;
                        sel.appendChild(opt);
                    });
                });
            });
            showToast('Group updated successfully', 'success');
        }).catch(function(e) {
            logUiError('GROUP_EDIT_ERROR', e);
            showToast('Error saving group: ' + (e.message || 'Unknown'), 'danger');
        });
    });

    // ========== ADMIN USERS (super_admin) ==========
    window.loadAdminUsers = function() {
        var el = document.getElementById('adminUsersList');
        if (!el) return;
        supabaseClient.from(CONFIG.tables.profiles)
            .select('id,nombre_completo,documento_id,rol,grupo')
            .in('rol', ['teacher', 'admin', 'super_admin'])
            .order('rol')
            .order('nombre_completo')
            .then(function(result) {
                var list = result.data || [];
                if (!list.length) {
                    el.innerHTML = '<p class="text-muted small">No admin users found.</p>';
                    return;
                }
                el.innerHTML = '<div class="admin-table-wrap"><table class="table table-sm"><thead><tr><th>Name</th><th>Document</th><th>Role</th><th>Group</th><th>Actions</th></tr></thead><tbody>' +
                    list.map(function(u) {
                        var role = String(u.rol || '').toLowerCase();
                        var uid = String(u.id || '').replace(/'/g, "\\'");
                        var canEdit = isSuperAdmin && canUserEditTarget(user.rol, role);
                        var canDel = isSuperAdmin && canUserDeleteTarget(user.rol, role);
                        var actions = canEdit
                            ? '<button type="button" class="btn btn-sm btn-outline-primary admin-action-btn me-1" onclick="editAdminUserPrompt(\'' + uid + '\',\'' + escapeAttr(u.nombre_completo || '') + '\',\'' + escapeAttr(u.documento_id || '') + '\',\'' + escapeAttr(u.rol || '') + '\',\'' + escapeAttr(u.grupo || '') + '\')">Edit</button>'
                            : '<span class="small text-muted">' + (role === 'super_admin' ? 'Protected' : '-') + '</span>';
                        if (canDel) {
                            actions += '<button type="button" class="btn btn-sm btn-outline-danger admin-action-btn me-1" onclick="deleteAdminUser(\'' + uid + '\',\'' + escapeAttr(u.rol || '') + '\')">Del</button>';
                        }
                        if (isSuperAdmin) {
                            actions += '<button type="button" class="btn btn-sm btn-outline-warning admin-action-btn me-1" onclick="godResetPin(\'' + uid + '\',\'' + escapeAttr(u.nombre_completo || '') + '\')" title="Reset PIN">üîë</button>';
                            actions += '<button type="button" class="btn btn-sm btn-outline-secondary admin-action-btn me-1" onclick="godToggleLock(\'' + uid + '\',\'' + escapeAttr(u.nombre_completo || '') + '\')" title="Lock/Unlock">üîí</button>';
                            actions += '<button type="button" class="btn btn-sm btn-outline-info admin-action-btn" onclick="godForceReset(\'' + uid + '\',\'' + escapeAttr(u.nombre_completo || '') + '\')" title="Force Reset on Login">‚ö°</button>';
                        }
                        return '<tr><td class="cell-ellipsis" title="' + escapeAttr(u.nombre_completo || '') + '">' + escapeHtml(u.nombre_completo || '') + '</td><td class="cell-ellipsis" title="' + escapeAttr(u.documento_id || '') + '">' + escapeHtml(u.documento_id || '') + '</td><td>' + escapeHtml(u.rol || '') + '</td><td class="cell-ellipsis" title="' + escapeAttr(u.grupo || '-') + '">' + escapeHtml(u.grupo || '-') + '</td><td>' + actions + '</td></tr>';
                    }).join('') +
                    '</tbody></table></div>';
            })
            .catch(function(e) {
                el.innerHTML = '<div class="alert alert-danger">Error loading admin users: ' + (e.message || 'Unknown') + '</div>';
            });
    };

    window.editAdminUserPrompt = function(adminId, currentName, currentDoc, currentRole, currentGroup) {
        if (!isSuperAdmin) { showToast('Only super_admin can edit admin users', 'danger'); return; }
        var safeRole = String(currentRole || '').toLowerCase();
        if (safeRole === 'super_admin') { showToast('super_admin cannot be edited here', 'danger'); return; }

        var name = prompt('Edit full name:', currentName || '');
        if (name == null) return;
        name = String(name || '').trim();
        if (name.length < 3 || name.length > 100) { showToast('Name must be 3-100 chars', 'danger'); return; }

        var doc = prompt('Edit document ID:', currentDoc || '');
        if (doc == null) return;
        doc = String(doc || '').trim();
        if (!/^[A-Za-z0-9_-]{3,32}$/.test(doc)) { showToast('Document must be 3-32 chars (letters, numbers, _ or -)', 'danger'); return; }

        var roleInput = prompt('Role (teacher/admin):', safeRole || 'teacher');
        if (roleInput == null) return;
        var role = String(roleInput || '').trim().toLowerCase();
        if (!['teacher', 'admin'].includes(role)) { showToast('Role must be teacher or admin', 'danger'); return; }

        var groupInput = prompt('Group code (optional):', currentGroup || '');
        if (groupInput == null) return;
        var group = String(groupInput || '').trim();

        var pinInput = prompt('New PIN (optional, 4-12 digits): leave blank to keep current', '');
        if (pinInput == null) return;
        var pin = String(pinInput || '').trim();
        if (pin && !/^\d{4,12}$/.test(pin)) { showToast('PIN must be 4-12 digits', 'danger'); return; }

        var payload = {
            nombre_completo: name,
            documento_id: doc,
            rol: role,
            grupo: group || null
        };
        if (pin) payload.pin = pin;

        updateProfile(adminId, payload).then(function() {
            showToast('Admin user updated', 'success');
            window.loadAdminUsers();
        }).catch(function(e) {
            logUiError('ADMIN_EDIT_ERROR', e);
            showToast('Error updating admin user: ' + (e.message || 'Unknown'), 'danger');
        });
    };

    window.deleteAdminUser = function(adminId, role) {
        if (!isSuperAdmin) { showToast('Only super_admin can delete admin users', 'danger'); return; }
        var safeRole = String(role || '').toLowerCase();
        if (safeRole === 'super_admin') {
            showToast('super_admin cannot be deleted', 'danger');
            return;
        }
        if (!confirm('Delete this admin user? This cannot be undone.')) return;
        deleteStudent(adminId).then(function() {
            showToast('Admin user deleted', 'success');
            window.loadAdminUsers();
        }).catch(function(e) {
            logUiError('ADMIN_DELETE_ERROR', e);
            showToast('Error deleting admin user: ' + (e.message || 'Unknown'), 'danger');
        });
    };

    // ========== GOD MODE ACTIONS (super_admin only) ==========
    window.godResetPin = async function(userId, userName) {
        if (!isSuperAdmin) { showToast('Only super_admin', 'danger'); return; }
        var newPin = prompt('Enter new PIN for ' + userName + ' (4-12 digits):', '');
        if (newPin == null || !newPin.trim()) return;
        newPin = newPin.trim();
        if (!/^\d{4,12}$/.test(newPin)) { showToast('PIN must be 4-12 digits', 'danger'); return; }
        try {
            await resetUserPassword(userId, newPin);
            showToast('PIN reset for ' + userName, 'success');
        } catch (e) {
            showToast('Reset failed: ' + (e.message || 'Unknown'), 'danger');
        }
    };

    window.godToggleLock = async function(userId, userName) {
        if (!isSuperAdmin) { showToast('Only super_admin', 'danger'); return; }
        var action = confirm('Lock account for ' + userName + '?\n\nOK = Lock\nCancel = Unlock');
        try {
            if (action) {
                await lockAccount(userId);
                showToast(userName + ' account LOCKED', 'warning');
            } else {
                await unlockAccount(userId);
                showToast(userName + ' account UNLOCKED', 'success');
            }
            window.loadAdminUsers();
        } catch (e) {
            showToast('Error: ' + (e.message || 'Unknown'), 'danger');
        }
    };

    window.godForceReset = async function(userId, userName) {
        if (!isSuperAdmin) { showToast('Only super_admin', 'danger'); return; }
        if (!confirm('Force ' + userName + ' to reset password on next login?')) return;
        try {
            await forcePasswordResetOnLogin(userId);
            showToast(userName + ' will be forced to reset password on next login', 'success');
        } catch (e) {
            showToast('Error: ' + (e.message || 'Unknown'), 'danger');
        }
    };

    var createAdminBusy = false;
    document.getElementById('btnCreateAdminUser').addEventListener('click', function() {
        if (createAdminBusy) return;
        if (!isSuperAdmin) { showToast('Only super_admin can create admin users', 'danger'); return; }
        var name = document.getElementById('newAdminName').value.trim();
        var doc = document.getElementById('newAdminDoc').value.trim();
        var pin = document.getElementById('newAdminPin').value.trim();
        var role = document.getElementById('newAdminRole').value;
        if (!name || !doc || !pin) { showToast('Complete all fields', 'danger'); return; }
        if (name.length < 3 || name.length > 100) { showToast('Name must be 3-100 chars', 'danger'); return; }
        if (!/^[A-Za-z0-9_-]{3,32}$/.test(doc)) { showToast('Document must be 3-32 chars (letters, numbers, _ or -)', 'danger'); return; }
        if (!/^\d{4,12}$/.test(pin)) { showToast('PIN must be 4-12 digits', 'danger'); return; }
        if (!['teacher', 'admin'].includes(role)) { showToast('Invalid role', 'danger'); return; }

        var btn = document.getElementById('btnCreateAdminUser');
        createAdminBusy = true;
        if (btn) { btn.disabled = true; btn.textContent = 'Creating...'; }

        supabaseClient.from(CONFIG.tables.profiles).insert([{
            nombre_completo: name,
            documento_id: doc,
            pin: pin,
            grupo: null,
            monedas: 0,
            rol: role,
            current_streak: 0
        }]).then(function(result) {
            if (result.error) throw result.error;
            document.getElementById('newAdminName').value = '';
            document.getElementById('newAdminDoc').value = '';
            document.getElementById('newAdminPin').value = '';
            window.loadAdminUsers();
            showToast('Admin user created', 'success');
        }).catch(function(e) {
            logUiError('ADMIN_CREATE_ERROR', e);
            showToast('Error creating admin user: ' + (e.message || 'Unknown'), 'danger');
        }).finally(function() {
            createAdminBusy = false;
            if (btn) { btn.disabled = false; btn.textContent = 'Create Admin User'; }
        });
    });
    
    // ========== CHALLENGES MANAGEMENT ==========
    window.loadChallengesList = function() {
        console.log('[ADMIN] Loading challenges...');
        var q = supabaseClient.from(CONFIG.tables.challenges).select('*').order('created_at', { ascending: false });
        if (isSchoolAdmin) {
            q = q.eq('status', 'active');
        }
        q.then(function(result) {
            var el = document.getElementById('challengesList');
            if (!el) return;
            if (!result.data || !result.data.length) {
                el.innerHTML = '<p class="text-muted small">No challenges yet.</p>';
                return;
            }
            el.innerHTML = '<div class="list-group">' + result.data.map(function(c) {
                var target = extractChallengeTarget(c);
                var scopeTxt = target ? ('Group: ' + escapeHtml(target)) : 'All groups';
                var payload = null;
                try { payload = typeof c.question_payload === 'string' ? JSON.parse(c.question_payload) : c.question_payload; } catch (_) {}
                var totalQuestions = payload && Array.isArray(payload.questions) ? payload.questions.length : 1;
                var status = c.status || 'active';
                var statusBadge = (status === 'closed')
                    ? '<span class="badge bg-secondary ms-2">Closed</span>'
                    : '<span class="badge bg-success ms-2">Active</span>';

                var actions = '';
                if (!isSchoolAdmin) {
                    var toggleBtn = (status === 'closed')
                        ? '<button class="btn btn-sm btn-outline-success me-1" onclick="toggleChallengeStatus(\'' + c.id + '\', \'active\')">Reopen</button>'
                        : '<button class="btn btn-sm btn-outline-warning me-1" onclick="toggleChallengeStatus(\'' + c.id + '\', \'closed\')">Close</button>';
                    var deleteBtn = '<button class="btn btn-sm btn-outline-danger" onclick="deleteChallenge(\'' + c.id + '\')">Delete</button>';
                    actions = '<div class="d-flex gap-1 mt-1">' + toggleBtn + deleteBtn + '</div>';
                }

                return '<div class="list-group-item d-flex justify-content-between align-items-start">' +
                    '<div><strong>' + escapeHtml(c.title || '') + '</strong>' + statusBadge + '<br>' +
                    '<small class="text-muted">' + (c.challenge_type || 'open') + ' ¬∑ ' + scopeTxt + ' ¬∑ Questions: ' + totalQuestions + '</small></div>' +
                    (actions || '<div></div>') +
                    '</div>';
            }).join('') + '</div>';
        });
    };

    window.toggleChallengeStatus = function(challengeId, newStatus) {
        supabaseClient.from(CONFIG.tables.challenges)
            .update({ status: newStatus })
            .eq('id', challengeId)
            .then(function(result) {
                if (result.error) { showToast('Error: ' + result.error.message, 'danger'); return; }
                showToast('Challenge ' + (newStatus === 'closed' ? 'closed' : 'reopened'), 'success');
                window.loadChallengesList();
            });
    };

    window.deleteChallenge = function(challengeId) {
        if (!confirm('Delete this challenge? All student submissions will also be deleted. This cannot be undone.')) return;
        supabaseClient.from(CONFIG.tables.challenge_submissions).delete().eq('challenge_id', challengeId)
            .then(function(result) {
                if (result && result.error) throw result.error;
                return supabaseClient.from(CONFIG.tables.challenge_questions).delete().eq('challenge_id', challengeId);
            })
            .then(function(result) {
                if (result && result.error && !isMissingRelationError(result.error, CONFIG.tables.challenge_questions)) throw result.error;
                return supabaseClient.from(CONFIG.tables.challenges).delete().eq('id', challengeId);
            })
            .then(function(result) {
                if (result.error) { showToast('Error deleting challenge: ' + result.error.message, 'danger'); return; }
                showToast('Challenge deleted', 'success');
                window.loadChallengesList();
            })
            .catch(function(e) {
                showToast('Delete failed: ' + (e.message || 'Unknown'), 'danger');
            });
    };

    document.getElementById('challengeScope').addEventListener('change', function() {
        var scope = this.value;
        var targetSel = document.getElementById('challengeTargetGroup');
        if (!targetSel) return;
        targetSel.style.display = scope === 'group' ? '' : 'none';
    });
    document.getElementById('btnAddChallengeQuestion').addEventListener('click', function() {
        addChallengeQuestion('multiple_choice');
    });
    
    var createChallengeBusy = false;
    document.getElementById('btnCreateChallenge').addEventListener('click', function() {
        if (createChallengeBusy) return;
        var title = document.getElementById('challengeTitle').value.trim();
        var desc = document.getElementById('challengeDescription').value.trim();
        var scope = document.getElementById('challengeScope').value;
        var targetGroup = document.getElementById('challengeTargetGroup').value;
        if (!title) { showToast('Enter challenge title', 'danger'); return; }
        if (title.length > 120) { showToast('Challenge title is too long (max 120)', 'danger'); return; }
        if (desc.length > 500) { showToast('Description is too long (max 500)', 'danger'); return; }
        if (scope === 'group' && !targetGroup) { showToast('Select a target group', 'danger'); return; }

        var questions;
        try {
            questions = collectChallengeQuestionsForSave();
        } catch (e) {
            showToast(e.message || 'Invalid question builder data', 'danger');
            return;
        }

        var firstQuestion = questions[0] || null;
        var payload = {
            title: title,
            description: desc,
            question_text: firstQuestion ? firstQuestion.question_text : (desc || title),
            question_payload: {
                questions: questions.map(function(q, idx) {
                    return {
                        id: 'q-' + (idx + 1),
                        order_index: idx + 1,
                        question_type: q.question_type,
                        question_text: q.question_text,
                        payload: q.payload,
                        correct_answer: q.correct_answer
                    };
                })
            },
            challenge_type: firstQuestion ? firstQuestion.question_type : 'open',
            correct_answer: firstQuestion ? firstQuestion.correct_answer : '',
            options: firstQuestion && firstQuestion.payload && firstQuestion.payload.options ? firstQuestion.payload.options : null,
            status: 'active',
            max_winners: 10,
            current_winners: 0
        };
        if (scope === 'group') {
            payload.scope = 'group';
            payload.target_group = targetGroup;
            payload.group_code = targetGroup;
            payload.target_groups = [targetGroup];
        } else {
            payload.scope = 'all';
            payload.target_group = null;
            payload.group_code = null;
            payload.target_groups = null;
        }

        var btn = document.getElementById('btnCreateChallenge');
        createChallengeBusy = true;
        if (btn) { btn.disabled = true; btn.textContent = 'Creating...'; }
        createChallengeWithQuestions(payload, questions).then(function() {
            document.getElementById('challengeTitle').value = '';
            document.getElementById('challengeDescription').value = '';
            document.getElementById('challengeScope').value = 'all';
            document.getElementById('challengeTargetGroup').value = '';
            document.getElementById('challengeTargetGroup').style.display = 'none';
            challengeBuilderState = [defaultChallengeQuestion('multiple_choice')];
            renderChallengeBuilder();
            window.loadChallengesList();
            showToast('Challenge created', 'success');
        }).catch(function(e) {
            logUiError('CHALLENGE_CREATE_ERROR', e);
            showToast('Error creating challenge: ' + (e.message || 'Unknown'), 'danger');
        }).finally(function() {
            createChallengeBusy = false;
            if (btn) { btn.disabled = false; btn.textContent = 'Create Challenge'; }
        });
    });
    
    // ========== BILLING CLAIMS ==========
    window.loadBillingClaims = function() {
        console.log('[ADMIN] Loading billing claims...');
        getPendingBillingClaims().then(function(claims) {
            var el = document.getElementById('billingClaimsList');
            if (!claims || !claims.length) {
                el.innerHTML = '<p class="text-muted small">No pending claims.</p>';
                return;
            }
            el.innerHTML = '<div class="list-group">' + claims.map(function(c) {
                return '<div class="list-group-item d-flex justify-content-between align-items-center">' +
                    '<div><strong>' + escapeHtml(c.student_name || c.student_id) + '</strong><br>' +
                    '<small class="text-muted">Item: ' + escapeHtml(c.item_name) + ' ¬∑ Group: ' + escapeHtml(c.group_code || '-') + '</small></div>' +
                    '<button class="btn btn-sm btn-success" onclick="confirmDeliveryClick(\'' + c.id + '\', null)">Confirm Delivery</button>' +
                    '</div>';
            }).join('') + '</div>';
        });
    };
    
    window.confirmDeliveryClick = function(claimId, inventoryId) {
        confirmDelivery(claimId, inventoryId).then(function(result) {
            if (result.ok) {
                showToast('Delivery confirmed', 'success');
                window.loadBillingClaims();
            } else {
                showToast('Error: ' + (result.error || 'Unknown'), 'danger');
            }
        });
    };
    
    // ========== ANNOUNCEMENTS ==========
    window.loadAnnouncementsList = function() {
        console.log('[ADMIN] Loading announcements...');
        getAnnouncementsForAdmin().then(function(announcements) {
            var el = document.getElementById('announcementsList');
            if (!announcements || !announcements.length) {
                el.innerHTML = '<p class="text-muted small">No announcements yet.</p>';
                return;
            }
            function toneClass(t) {
                if (t === 'warning') return 'alert-warning';
                if (t === 'danger') return 'alert-danger';
                if (t === 'success') return 'alert-success';
                return 'alert-info';
            }
            el.innerHTML = '<div class="list-group">' + announcements.map(function(a) {
                var linksHtml = Array.isArray(a.links) && a.links.length
                    ? '<div class="small mt-1">' + a.links.map(function(l) {
                        var label = escapeHtml(l.label || l.url || 'link');
                        var url = escapeHtml(l.url || '#');
                        return '<a href="' + url + '" target="_blank" rel="noopener" class="me-2">' + label + '</a>';
                    }).join('') + '</div>'
                    : '';
                return '<div class="list-group-item alert ' + toneClass(String(a.alert_type || 'info')) + ' d-flex justify-content-between align-items-start gap-2"><div><strong>' + escapeHtml(a.title || 'Announcement') + '</strong><br><span>' + escapeHtml(a.message || '') + '</span><br>' +
                    '<small class="text-muted">Group: ' + escapeHtml(a.target_group || 'All') + ' ¬∑ Expires: ' + escapeHtml(a.expiry_date || '-') + '</small>' + linksHtml + '</div>' +
                    '<div class="d-flex gap-1"><button class="btn btn-sm btn-outline-primary" onclick="editAnnouncementForm(\'' + String(a.id || '').replace(/'/g, "\\'") + '\')">Edit</button>' +
                    '<button class="btn btn-sm btn-outline-danger" onclick="deleteAnnouncementClick(\'' + String(a.id || '').replace(/'/g, "\\'") + '\')">Delete</button></div></div>';
            }).join('') + '</div>';
        }).catch(function(e) {
            logUiError('ANNOUNCEMENTS_LOAD_ERROR', e);
            document.getElementById('announcementsList').innerHTML = '<div class="alert alert-danger">Error loading announcements</div>';
        });
    };

    window.editAnnouncementForm = function(announcementId) {
        getAnnouncementsForAdmin().then(function(all) {
            var row = (all || []).find(function(a) { return String(a.id) === String(announcementId); });
            if (!row) {
                showToast('Announcement not found', 'danger');
                return;
            }
            document.getElementById('announcementEditId').value = row.id;
            document.getElementById('announcementTitle').value = row.title || '';
            document.getElementById('announcementMessage').value = row.message || '';
            document.getElementById('announcementType').value = row.alert_type || 'info';
            document.getElementById('announcementGroup').value = row.target_group || '';
            document.getElementById('announcementExpiry').value = row.expiry_date || '';
            document.getElementById('announcementLinks').value = Array.isArray(row.links)
                ? row.links.map(function(l) { return (l.label || '') + '|' + (l.url || ''); }).join('\n')
                : '';
            document.getElementById('btnCreateAnnouncement').textContent = 'Update Announcement';
            document.getElementById('btnCancelAnnouncementEdit').style.display = '';
        }).catch(function(e) {
            logUiError('ANNOUNCEMENT_EDIT_LOAD_ERROR', e);
            showToast('Could not load announcement for editing', 'danger');
        });
    };

    function resetAnnouncementForm() {
        document.getElementById('announcementEditId').value = '';
        document.getElementById('announcementTitle').value = '';
        document.getElementById('announcementMessage').value = '';
        document.getElementById('announcementType').value = 'info';
        document.getElementById('announcementLinks').value = '';
        document.getElementById('announcementExpiry').value = '';
        document.getElementById('announcementGroup').value = '';
        document.getElementById('btnCreateAnnouncement').textContent = 'Create Announcement';
        document.getElementById('btnCancelAnnouncementEdit').style.display = 'none';
    }

    window.deleteAnnouncementClick = function(announcementId) {
        if (!confirm('Delete this announcement?')) return;
        deleteAnnouncement(announcementId).then(function() {
            showToast('Announcement deleted', 'success');
            window.loadAnnouncementsList();
        }).catch(function(e) {
            logUiError('ANNOUNCEMENT_DELETE_ERROR', e);
            showToast('Error deleting announcement: ' + (e.message || 'Unknown'), 'danger');
        });
    };
    
    var saveAnnouncementBusy = false;
    document.getElementById('btnCreateAnnouncement').addEventListener('click', function() {
        if (saveAnnouncementBusy) return;
        var editId = document.getElementById('announcementEditId').value;
        var title = document.getElementById('announcementTitle').value.trim();
        var message = document.getElementById('announcementMessage').value.trim();
        var group = document.getElementById('announcementGroup').value;
        var expiry = document.getElementById('announcementExpiry').value;
        var alertType = document.getElementById('announcementType').value || 'info';
        var linksRaw = document.getElementById('announcementLinks').value || '';
        if (!message || !expiry) { showToast('Enter message and expiry date', 'danger'); return; }
        if (title.length > 120) { showToast('Title too long (max 120)', 'danger'); return; }
        if (message.length > 1000) { showToast('Message too long (max 1000)', 'danger'); return; }
        var btn = document.getElementById('btnCreateAnnouncement');
        saveAnnouncementBusy = true;
        if (btn) { btn.disabled = true; btn.textContent = editId ? 'Updating...' : 'Creating...'; }
        var op = editId
            ? updateAnnouncement(editId, message, group || null, expiry, {
                title: title || null,
                alertType: alertType,
                links: parseAnnouncementLinks(linksRaw)
            })
            : createAnnouncement(message, group || null, expiry, {
                title: title || null,
                alertType: alertType,
                links: parseAnnouncementLinks(linksRaw)
            });
        op.then(function() {
            resetAnnouncementForm();
            window.loadAnnouncementsList();
            showToast(editId ? 'Announcement updated' : 'Announcement created', 'success');
        }).catch(function(e) {
            logUiError(editId ? 'ANNOUNCEMENT_UPDATE_ERROR' : 'ANNOUNCEMENT_CREATE_ERROR', e);
            showToast('Error saving announcement: ' + (e.message || 'Unknown'), 'danger');
        }).finally(function() {
            saveAnnouncementBusy = false;
            if (btn) btn.disabled = false;
            if (btn) btn.textContent = editId ? 'Update Announcement' : 'Create Announcement';
        });
    });

    document.getElementById('btnCancelAnnouncementEdit').addEventListener('click', function() {
        resetAnnouncementForm();
    });

    // ========== AI STRUCTURED GENERATION (Drako + Credits + Multi-AI) ==========
    function updateDrako(message, credits) {
        var msgEl = document.getElementById('drako-message');
        var credEl = document.getElementById('drako-credits');
        if (msgEl && message != null) msgEl.innerHTML = message;
        if (credEl && credits != null) credEl.textContent = 'üî• Tienes ' + credits + ' creditos restantes.';
    }

    async function refreshDrakoPanel() {
        try {
            var credits = await getTeacherCredits(user.id);
            user.teacher_credits = credits;
            try { localStorage.setItem('lingoCoins_user', JSON.stringify(user)); } catch (_) {}
            var limitInfo = await checkAiLimit();
            var usageEl = document.getElementById('aiUsageInfo');
            if (usageEl) usageEl.textContent = 'Plan: ' + limitInfo.plan + ' | Pool: ' + limitInfo.used + '/' + limitInfo.limit + ' | Provider: ' + (limitInfo.provider || 'anthropic');
            updateDrako('Listo para generar. Elige los parametros y haz clic en <b>Generar Reto</b>.', credits);
        } catch (e) {
            updateDrako('Error cargando datos: ' + escapeHtml(e.message || ''), 0);
        }
    }

    async function fetchInstitutionAIConfig(institutionId) {
        if (!institutionId) {
            return { provider: 'anthropic', apiKey: '' };
        }

        async function getCentralApiKey(providerName) {
            try {
                if (typeof getSystemConfig !== 'function') return '';
                var keyPack = await getSystemConfig('api_keys');
                var parsed = keyPack;
                if (typeof keyPack === 'string') {
                    try { parsed = JSON.parse(keyPack); } catch (_) { parsed = null; }
                }
                if (!parsed || typeof parsed !== 'object') return '';
                var prov = String(providerName || '').toLowerCase();
                if (prov === 'chatgpt') prov = 'openai';
                if (prov === 'claude') prov = 'anthropic';
                if (prov === 'gemini') prov = 'google';
                return String(parsed[prov] || '').trim();
            } catch (_) {
                return '';
            }
        }

        var cfg = await supabaseClient
            .from(CONFIG.tables.institutions)
            .select('active_ai_provider, active_ai_key')
            .eq('id', institutionId)
            .maybeSingle();
        if (cfg.error && (isMissingColumnError(cfg.error, 'active_ai_provider', CONFIG.tables.institutions)
            || isMissingColumnError(cfg.error, 'active_ai_key', CONFIG.tables.institutions))) {
            var fallbackProvider = 'anthropic';
            var fallbackKey = await getCentralApiKey(fallbackProvider);
            return { provider: fallbackProvider, apiKey: fallbackKey };
        }
        if (cfg.error) throw cfg.error;
        var provider = String((cfg.data && cfg.data.active_ai_provider) || 'anthropic').toLowerCase();
        var apiKey = String((cfg.data && cfg.data.active_ai_key) || '').trim();
        if (!apiKey) {
            apiKey = await getCentralApiKey(provider);
        }
        return {
            provider: provider,
            apiKey: apiKey
        };
    }

    document.getElementById('btnGenerateAI').addEventListener('click', function() {
        var panel = document.getElementById('aiGeneratePanel');
        if (!panel) return;
        panel.style.display = panel.style.display === 'none' ? '' : 'none';
        if (panel.style.display !== 'none') {
            refreshDrakoPanel();
        }
    });

    var aiStructuredBusy = false;
    document.getElementById('btnRunStructuredAI').addEventListener('click', async function() {
        if (aiStructuredBusy) return;
        var cefrLevel = document.getElementById('aiCefrLevel').value || 'B1';
        var skill = document.getElementById('aiSkill').value || 'Grammar';
        var role = (document.getElementById('aiRole').value || '').trim();
        var context = (document.getElementById('aiContext').value || '').trim();
        var topic = (document.getElementById('aiTopic').value || '').trim();
        var count = parseInt(document.getElementById('aiQuestionCount').value) || 5;
        var statusEl = document.getElementById('aiGenerateStatus');

        if (!topic) { showToast('Ingresa un tema (Topic)', 'danger'); return; }
        if (count < 1 || count > 20) { showToast('Cantidad de preguntas: 1-20', 'danger'); return; }

        aiStructuredBusy = true;
        var btn = document.getElementById('btnRunStructuredAI');
        if (btn) { btn.disabled = true; btn.textContent = 'Generando...'; }
        if (statusEl) statusEl.innerHTML = '<div class="spinner-border spinner-border-sm text-warning" role="status"></div> Verificando creditos...';
        updateDrako('üêâ Verificando tus creditos...', null);

        try {
            var credits = await getTeacherCredits(user.id);
            user.teacher_credits = credits;

            if (credits < 3) {
                updateDrako('üî• ¬°Te quedaste sin creditos! Pidele mas a tu Admin.', credits);
                if (statusEl) statusEl.innerHTML = '<span class="text-danger">Creditos insuficientes (' + credits + ' < 3)</span>';
                showToast('Creditos insuficientes. Necesitas al menos 3.', 'danger');
                return;
            }

            var limitCheck = await checkAiLimit();
            var usageEl = document.getElementById('aiUsageInfo');
            if (usageEl) usageEl.textContent = 'Plan: ' + limitCheck.plan + ' | Pool: ' + limitCheck.used + '/' + limitCheck.limit;

            if (!limitCheck.allowed) {
                updateDrako('üîí El pool de IA de tu institucion se agoto. Contacta al administrador.', credits);
                if (statusEl) statusEl.innerHTML = '<span class="text-danger">Pool institucional agotado (' + limitCheck.used + '/' + limitCheck.limit + ')</span>';
                return;
            }

            var instId = limitCheck.institution ? limitCheck.institution.id : null;
            var aiCfg = await fetchInstitutionAIConfig(instId);
            var selectedProvider = aiCfg.provider || (limitCheck.provider || 'anthropic');
            var apiKey = aiCfg.apiKey;
            if (!apiKey) {
                updateDrako('üîí La institucion no tiene API key configurada. Contacta al super_admin.', credits);
                if (statusEl) statusEl.innerHTML = '<span class="text-danger">No API key configured for this institution.</span>';
                return;
            }

            if (statusEl) statusEl.innerHTML = '<div class="spinner-border spinner-border-sm text-warning" role="status"></div> Llamando a ' + selectedProvider + '...';
            updateDrako('üêâ Contactando a ' + selectedProvider.toUpperCase() + '... esto toma unos segundos.', credits);

            var systemPrompt = 'You are an expert English language teacher. Create quiz questions strictly following the parameters given. Return ONLY valid JSON array, no markdown, no explanation.';
            var userPrompt = 'Generate ' + count + ' English language quiz questions with these parameters:\n' +
                '- CEFR Level: ' + cefrLevel + '\n' +
                '- Skill Focus: ' + skill + '\n' +
                (role ? '- Student Role: ' + role + '\n' : '') +
                (context ? '- Situational Context: ' + context + '\n' : '') +
                '- Topic: ' + topic + '\n\n' +
                'Return a JSON array where each object has:\n' +
                '- "question_text": the question string\n' +
                '- "question_type": one of "multiple_choice", "true_false", or "open"\n' +
                '- "options": array of 4 option strings (for multiple_choice), ["True","False"] (for true_false), or [] (for open)\n' +
                '- "correct_answer": the correct answer string (must match one option exactly for MC/TF)\n\n' +
                'Mix question types. Ensure difficulty matches CEFR ' + cefrLevel + '. Return ONLY the JSON array.';

            var rawContent = await routeAIRequest(selectedProvider, apiKey, systemPrompt, userPrompt, {
                userId: user.id,
                institutionId: limitCheck.institution ? limitCheck.institution.id : null,
                plan: limitCheck.plan,
                cefrLevel: cefrLevel,
                skill: skill,
                topic: topic,
                creditsToCharge: 3
            });
            rawContent = rawContent.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();
            var questions = JSON.parse(rawContent);
            if (!Array.isArray(questions) || !questions.length) throw new Error('AI returned invalid question format');

            challengeBuilderState = questions.map(function(q) {
                var qType = normalizeQuestionTypeAdmin(q.question_type || 'multiple_choice');
                var model = defaultChallengeQuestion(qType);
                model.question_text = String(q.question_text || '');
                if (Array.isArray(q.options) && q.options.length) {
                    model.options = q.options.map(function(o) { return String(o || ''); });
                }
                model.correct_answer = String(q.correct_answer || '');
                return ensureQuestionModelDefaults(model);
            });
            renderChallengeBuilder();

            await incrementAiUsage(limitCheck.institution.id);
            var newCredits = await deductTeacherCredits(user.id, 3);
            user.teacher_credits = newCredits;
            try { localStorage.setItem('lingoCoins_user', JSON.stringify(user)); } catch (_) {}

            updateDrako('‚úÖ ¬°Listo! Genere ' + questions.length + ' preguntas CEFR ' + cefrLevel + '. Revisalas arriba y publica el reto.', newCredits);
            if (usageEl) usageEl.textContent = 'Plan: ' + limitCheck.plan + ' | Pool: ' + (limitCheck.used + 1) + '/' + limitCheck.limit;
            if (statusEl) statusEl.innerHTML = '<span class="text-success">‚úÖ ' + questions.length + ' preguntas generadas. Revisa y crea el reto.</span>';
            showToast('Drako genero ' + questions.length + ' preguntas. Revisalas arriba.', 'success');

            if (!document.getElementById('challengeTitle').value.trim()) {
                document.getElementById('challengeTitle').value = topic + ' (CEFR ' + cefrLevel + ' - ' + skill + ')';
            }

        } catch (e) {
            logUiError('AI_STRUCTURED_GENERATE_ERROR', e);
            updateDrako('‚ùå Error: ' + escapeHtml(e.message || 'Desconocido'), user.teacher_credits || 0);
            if (statusEl) statusEl.innerHTML = '<span class="text-danger">Error: ' + escapeHtml(e.message || 'Unknown') + '</span>';
            showToast('Error en generacion IA: ' + (e.message || 'Unknown'), 'danger');
        } finally {
            aiStructuredBusy = false;
            if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-stars"></i> Generar Reto (Costo: 3 Creditos)'; }
        }
    });

    // ========== IMPROVEMENT PLANS (FASE 2 & 3) ==========
    var improvementModalEl = null;

    window.openImprovementModal = function(studentId, studentName) {
        document.getElementById('improvementStudentId').value = studentId || '';
        document.getElementById('improvementStudentName').value = studentName || '';
        document.getElementById('improvementTopic').value = '';
        document.getElementById('improvementEntryCost').value = '5';
        document.getElementById('improvementReward').value = '50';
        if (!improvementModalEl) improvementModalEl = new bootstrap.Modal(document.getElementById('modalImprovementPlan'));
        improvementModalEl.show();
    };

    var submitPlanBusy = false;
    document.getElementById('btnSubmitImprovementPlan').addEventListener('click', async function() {
        if (submitPlanBusy) return;
        var studentId = document.getElementById('improvementStudentId').value;
        var topic = (document.getElementById('improvementTopic').value || '').trim();
        var entryCost = parseInt(document.getElementById('improvementEntryCost').value) || 5;
        var reward = parseInt(document.getElementById('improvementReward').value) || 50;

        if (!studentId) { showToast('No student selected', 'danger'); return; }
        if (!topic) { showToast('Enter a critical topic for the plan', 'danger'); return; }
        if (topic.length > 200) { showToast('Topic too long (max 200 chars)', 'danger'); return; }

        submitPlanBusy = true;
        var btn = document.getElementById('btnSubmitImprovementPlan');
        if (btn) { btn.disabled = true; btn.textContent = 'Saving...'; }

        try {
            await createImprovementPlan(studentId, user.id, topic, entryCost, reward);
            if (improvementModalEl) improvementModalEl.hide();
            showToast('Plan asignado exitosamente. El estudiante debera pagar para iniciar la mision.', 'success');
        } catch (e) {
            logUiError('IMPROVEMENT_PLAN_CREATE_ERROR', e);
            showToast('Error creating plan: ' + (e.message || 'Unknown'), 'danger');
        } finally {
            submitPlanBusy = false;
            if (btn) { btn.disabled = false; btn.textContent = 'Emitir Plan'; }
        }
    });

    // ========== TRANSFER CREDITS (super_admin only) ==========
    if (isSuperAdmin) {
        window.loadAdminUsers && (function() {
            var origLoad = window.loadAdminUsers;
            window.loadAdminUsers = function() {
                origLoad();
                // Populate teacher dropdown
                supabaseClient.from(CONFIG.tables.profiles).select('id,nombre_completo,documento_id,rol')
                    .in('rol', ['teacher', 'admin']).order('nombre_completo').then(function(res) {
                    var sel = document.getElementById('transferTeacherSelect');
                    if (!sel || res.error) return;
                    sel.innerHTML = '<option value="">Select teacher...</option>';
                    (res.data || []).forEach(function(t) {
                        var opt = document.createElement('option');
                        opt.value = t.id;
                        opt.textContent = t.nombre_completo + ' (' + t.documento_id + ') [' + t.rol + ']';
                        sel.appendChild(opt);
                    });
                });
            };
        })();
    }

    var transferBusy = false;
    var btnTransfer = document.getElementById('btnTransferCredits');
    if (btnTransfer) {
        btnTransfer.addEventListener('click', async function() {
            if (transferBusy) return;
            if (!isSuperAdmin) { showToast('Only super_admin can transfer credits', 'danger'); return; }
            var teacherId = document.getElementById('transferTeacherSelect').value;
            var amount = parseInt(document.getElementById('transferAmount').value) || 0;
            var statusEl = document.getElementById('transferCreditsStatus');
            if (!teacherId) { showToast('Select a teacher', 'danger'); return; }
            if (amount < 1) { showToast('Amount must be at least 1', 'danger'); return; }

            transferBusy = true;
            btnTransfer.disabled = true;
            btnTransfer.textContent = 'Transferring...';
            if (statusEl) statusEl.innerHTML = '<div class="spinner-border spinner-border-sm text-warning"></div> Processing...';

            try {
                var inst = await getOrCreateInstitution();
                if (!inst || !inst.id) throw new Error('No institution found');
                var result = await transferCredits(inst.id, teacherId, amount);
                if (!result.ok) throw new Error(result.error || 'Transfer failed');
                if (statusEl) statusEl.innerHTML = '<span class="text-success">Transferred ' + amount + ' credits. New teacher balance: ' + result.newTeacherCredits + '</span>';
                showToast('Credits transferred successfully', 'success');
            } catch (e) {
                if (statusEl) statusEl.innerHTML = '<span class="text-danger">Error: ' + escapeHtml(e.message || 'Unknown') + '</span>';
                showToast('Transfer failed: ' + (e.message || 'Unknown'), 'danger');
            } finally {
                transferBusy = false;
                btnTransfer.disabled = false;
                btnTransfer.innerHTML = '<i class="bi bi-send"></i> Transfer Credits';
            }
        });
    }

    // ========== LLM ASSIGNMENT (super_admin only) ==========
    var btnAssignLLM = document.getElementById('btnAssignLLM');
    if (btnAssignLLM) {
        btnAssignLLM.addEventListener('click', async function() {
            if (!isSuperAdmin) { showToast('Only super_admin', 'danger'); return; }
            var provider = document.getElementById('llmProviderSelect').value;
            var statusEl = document.getElementById('llmAssignStatus');
            try {
                var inst = await getOrCreateInstitution();
                if (!inst || !inst.id) throw new Error('No institution found');
                var result = await assignLLMToInstitution(inst.id, provider);
                if (statusEl) statusEl.innerHTML = '<span class="text-success">LLM set to: ' + escapeHtml(result.provider) + '</span>';
                showToast('LLM provider assigned: ' + result.provider, 'success');
            } catch (e) {
                if (statusEl) statusEl.innerHTML = '<span class="text-danger">Error: ' + escapeHtml(e.message || 'Unknown') + '</span>';
                showToast('LLM assignment failed: ' + (e.message || 'Unknown'), 'danger');
            }
        });
    }

    // ========== OVERRIDE CREDITS (super_admin God Mode) ==========
    var btnOverrideInst = document.getElementById('btnOverrideInstCredits');
    if (btnOverrideInst) {
        btnOverrideInst.addEventListener('click', async function() {
            if (!isSuperAdmin) { showToast('Only super_admin', 'danger'); return; }
            var pool = document.getElementById('overrideInstPool').value;
            var used = document.getElementById('overrideInstUsed').value;
            var statusEl = document.getElementById('overrideCreditsStatus');
            if (pool === '' && used === '') { showToast('Enter at least one value', 'danger'); return; }
            try {
                var inst = await getOrCreateInstitution();
                if (!inst || !inst.id) throw new Error('No institution found');
                var newPool = pool !== '' ? parseInt(pool) : undefined;
                var newUsed = used !== '' ? parseInt(used) : undefined;
                await overrideInstitutionCredits(inst.id, newPool, newUsed);
                if (statusEl) statusEl.innerHTML = '<span class="text-success">Institution credits overridden</span>';
                showToast('Institution credits overridden', 'success');
            } catch (e) {
                if (statusEl) statusEl.innerHTML = '<span class="text-danger">Error: ' + escapeHtml(e.message || 'Unknown') + '</span>';
                showToast('Override failed: ' + (e.message || 'Unknown'), 'danger');
            }
        });
    }

    var btnOverrideTeacher = document.getElementById('btnOverrideTeacherCredits');
    if (btnOverrideTeacher) {
        btnOverrideTeacher.addEventListener('click', async function() {
            if (!isSuperAdmin) { showToast('Only super_admin', 'danger'); return; }
            var teacherId = document.getElementById('overrideTeacherSelect').value;
            var credits = document.getElementById('overrideTeacherCredits').value;
            var statusEl = document.getElementById('overrideCreditsStatus');
            if (!teacherId) { showToast('Select a teacher', 'danger'); return; }
            if (credits === '' || isNaN(parseInt(credits))) { showToast('Enter credits value', 'danger'); return; }
            try {
                await overrideTeacherCredits(teacherId, parseInt(credits));
                if (statusEl) statusEl.innerHTML = '<span class="text-success">Teacher credits set to ' + parseInt(credits) + '</span>';
                showToast('Teacher credits overridden', 'success');
            } catch (e) {
                if (statusEl) statusEl.innerHTML = '<span class="text-danger">Error: ' + escapeHtml(e.message || 'Unknown') + '</span>';
                showToast('Override failed: ' + (e.message || 'Unknown'), 'danger');
            }
        });
    }

    // Populate override teacher select when admins view loads
    if (isSuperAdmin) {
        var origLoadAdminForOverride = window.loadAdminUsers;
        window.loadAdminUsers = function() {
            origLoadAdminForOverride();
            supabaseClient.from(CONFIG.tables.profiles).select('id,nombre_completo,documento_id,rol')
                .in('rol', ['teacher', 'admin']).order('nombre_completo').then(function(res) {
                var sel = document.getElementById('overrideTeacherSelect');
                if (!sel || res.error) return;
                sel.innerHTML = '<option value="">Select teacher...</option>';
                (res.data || []).forEach(function(t) {
                    var opt = document.createElement('option');
                    opt.value = t.id;
                    opt.textContent = t.nombre_completo + ' (' + t.documento_id + ')';
                    sel.appendChild(opt);
                });
            });
        };
    }

    // Hide God Mode panels for non-super_admin
    if (!isSuperAdmin) {
        ['transferCreditsBlock', 'llmAssignBlock', 'overrideCreditsBlock'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });
    }

    // ========== BULK CSV IMPORT ==========
    document.getElementById('btnShowBulkImport').addEventListener('click', function() {
        var panel = document.getElementById('bulkImportPanel');
        if (panel) panel.style.display = panel.style.display === 'none' ? '' : 'none';
    });

    var bulkImportBusy = false;
    document.getElementById('btnRunBulkImport').addEventListener('click', async function() {
        if (bulkImportBusy) return;
        var fileInput = document.getElementById('csvFileInput');
        var statusEl = document.getElementById('bulkImportStatus');
        if (!fileInput || !fileInput.files || !fileInput.files.length) {
            showToast('Select a CSV file first', 'danger');
            return;
        }
        bulkImportBusy = true;
        var btn = document.getElementById('btnRunBulkImport');
        if (btn) { btn.disabled = true; btn.textContent = 'Importing...'; }
        if (statusEl) statusEl.innerHTML = '<div class="spinner-border spinner-border-sm text-warning" role="status"></div> Processing CSV...';

        try {
            var file = fileInput.files[0];
            var csvText = await file.text();
            var instId = null;
            try {
                var inst = await getOrCreateInstitution();
                instId = inst ? inst.id : null;
            } catch (_) {}
            var result = await processFlatFile(csvText, instId);
            var msg = 'Created: ' + result.created + ' | Skipped: ' + result.skipped;
            if (result.errors && result.errors.length) {
                msg += '<br><span class="text-danger">' + result.errors.slice(0, 10).map(function(e) { return escapeHtml(e); }).join('<br>') + '</span>';
                if (result.errors.length > 10) msg += '<br>... and ' + (result.errors.length - 10) + ' more errors';
            }
            if (statusEl) statusEl.innerHTML = '<span class="text-success">' + msg + '</span>';
            showToast('Import complete: ' + result.created + ' created, ' + result.skipped + ' skipped', result.created > 0 ? 'success' : 'warning');
            window.refreshStudents();
        } catch (e) {
            logUiError('BULK_IMPORT_ERROR', e);
            if (statusEl) statusEl.innerHTML = '<span class="text-danger">Error: ' + escapeHtml(e.message || 'Unknown') + '</span>';
            showToast('Bulk import failed: ' + (e.message || 'Unknown'), 'danger');
        } finally {
            bulkImportBusy = false;
            if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-upload"></i> Import Students'; }
        }
    });

    subscribeToAuctionChanges(function() {
        var storeView = document.getElementById('viewStore');
        if (storeView && storeView.classList.contains('active')) {
            window.loadAuctionList();
        }
    });
}); // End DOMContentLoaded
    </script>
</body>
</html>
